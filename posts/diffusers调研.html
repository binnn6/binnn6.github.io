<!doctype html>
<html>
<head>
<meta charset='UTF-8'><meta name='viewport' content='width=device-width initial-scale=1'>
<script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?1e5df434fabac33eae220777ebe00989";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script>
<!-- Google tag (gtag.js) -->
<script async="" src="https://www.googletagmanager.com/gtag/js?id=G-KY0TYQ5ZPJ"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-KY0TYQ5ZPJ');
</script>
<link href='https://fonts.googleapis.com/css?family=Open+Sans:400italic,700italic,700,400&subset=latin,latin-ext' rel='stylesheet' type='text/css' /><style type='text/css'>html {overflow-x: initial !important;}:root { --bg-color: #ffffff; --text-color: #333333; --select-text-bg-color: #B5D6FC; --select-text-font-color: auto; --monospace: "Lucida Console",Consolas,"Courier",monospace; --title-bar-height: 20px; }
.mac-os-11 { --title-bar-height: 28px; }
html { font-size: 14px; background-color: var(--bg-color); color: var(--text-color); font-family: "Helvetica Neue", Helvetica, Arial, sans-serif; -webkit-font-smoothing: antialiased; }
h1, h2, h3, h4, h5 { white-space: pre-wrap; }
body { margin: 0px; padding: 0px; height: auto; inset: 0px; font-size: 1rem; line-height: 1.428571; overflow-x: hidden; background: inherit; tab-size: 4; }
iframe { margin: auto; }
a.url { word-break: break-all; }
a:active, a:hover { outline: 0px; }
.in-text-selection, ::selection { text-shadow: none; background: var(--select-text-bg-color); color: var(--select-text-font-color); }
#write { margin: 0px auto; height: auto; width: inherit; word-break: normal; overflow-wrap: break-word; position: relative; white-space: normal; overflow-x: visible; padding-top: 36px; }
#write.first-line-indent p { text-indent: 2em; }
#write.first-line-indent li p, #write.first-line-indent p * { text-indent: 0px; }
#write.first-line-indent li { margin-left: 2em; }
.for-image #write { padding-left: 8px; padding-right: 8px; }
body.typora-export { padding-left: 30px; padding-right: 30px; }
.typora-export .footnote-line, .typora-export li, .typora-export p { white-space: pre-wrap; }
.typora-export .task-list-item input { pointer-events: none; }
@media screen and (max-width: 500px) {
  body.typora-export { padding-left: 0px; padding-right: 0px; }
  #write { padding-left: 20px; padding-right: 20px; }
}
#write li > figure:last-child { margin-bottom: 0.5rem; }
#write ol, #write ul { position: relative; }
img { max-width: 100%; vertical-align: middle; image-orientation: from-image; }
button, input, select, textarea { color: inherit; font-style: inherit; font-variant-caps: inherit; font-weight: inherit; font-stretch: inherit; font-size: inherit; line-height: inherit; font-family: inherit; font-size-adjust: inherit; font-kerning: inherit; font-variant-alternates: inherit; font-variant-ligatures: inherit; font-variant-numeric: inherit; font-variant-east-asian: inherit; font-variant-position: inherit; font-feature-settings: inherit; font-optical-sizing: inherit; font-variation-settings: inherit; }
input[type="checkbox"], input[type="radio"] { line-height: normal; padding: 0px; }
*, ::after, ::before { box-sizing: border-box; }
#write h1, #write h2, #write h3, #write h4, #write h5, #write h6, #write p, #write pre { width: inherit; }
#write h1, #write h2, #write h3, #write h4, #write h5, #write h6, #write p { position: relative; }
p { line-height: inherit; }
h1, h2, h3, h4, h5, h6 { break-after: avoid-page; break-inside: avoid; orphans: 4; }
p { orphans: 4; }
h1 { font-size: 2rem; }
h2 { font-size: 1.8rem; }
h3 { font-size: 1.6rem; }
h4 { font-size: 1.4rem; }
h5 { font-size: 1.2rem; }
h6 { font-size: 1rem; }
.md-math-block, .md-rawblock, h1, h2, h3, h4, h5, h6, p { margin-top: 1rem; margin-bottom: 1rem; }
.hidden { display: none; }
.md-blockmeta { color: rgb(204, 204, 204); font-weight: 700; font-style: italic; }
a { cursor: pointer; }
sup.md-footnote { padding: 2px 4px; background-color: rgba(238, 238, 238, 0.7); color: rgb(85, 85, 85); border-radius: 4px; cursor: pointer; }
sup.md-footnote a, sup.md-footnote a:hover { color: inherit; text-transform: inherit; text-decoration: inherit; }
#write input[type="checkbox"] { cursor: pointer; width: inherit; height: inherit; }
figure { overflow-x: auto; margin: 1.2em 0px; max-width: calc(100% + 16px); padding: 0px; }
figure > table { margin: 0px; }
thead, tr { break-inside: avoid; break-after: auto; }
thead { display: table-header-group; }
table { border-collapse: collapse; border-spacing: 0px; width: 100%; overflow: auto; break-inside: auto; text-align: left; }
table.md-table td { min-width: 32px; }
.CodeMirror-gutters { border-right-width: 0px; border-right-style: none; border-right-color: currentcolor; background-color: inherit; }
.CodeMirror-linenumber { -webkit-user-select: none; }
.CodeMirror { text-align: left; }
.CodeMirror-placeholder { opacity: 0.3; }
.CodeMirror pre { padding: 0px 4px; }
.CodeMirror-lines { padding: 0px; }
div.hr:focus { cursor: none; }
#write pre { white-space: pre-wrap; }
#write.fences-no-line-wrapping pre { white-space: pre; }
#write pre.ty-contain-cm { white-space: normal; }
.CodeMirror-gutters { margin-right: 4px; }
.md-fences { font-size: 0.9rem; display: block; break-inside: avoid; text-align: left; overflow: visible; white-space: pre; background: inherit; position: relative !important; }
.md-fences-adv-panel { width: 100%; margin-top: 10px; text-align: center; padding-top: 0px; padding-bottom: 8px; overflow-x: auto; }
#write .md-fences.mock-cm { white-space: pre-wrap; }
.md-fences.md-fences-with-lineno { padding-left: 0px; }
#write.fences-no-line-wrapping .md-fences.mock-cm { white-space: pre; overflow-x: auto; }
.md-fences.mock-cm.md-fences-with-lineno { padding-left: 8px; }
.CodeMirror-line, twitterwidget { break-inside: avoid; }
svg { break-inside: avoid; }
.footnotes { opacity: 0.8; font-size: 0.9rem; margin-top: 1em; margin-bottom: 1em; }
.footnotes + .footnotes { margin-top: 0px; }
.md-reset { margin: 0px; padding: 0px; border: 0px; outline: 0px; vertical-align: top; background: 0px 0px; text-decoration: none; text-shadow: none; float: none; position: static; width: auto; height: auto; white-space: nowrap; cursor: inherit; line-height: normal; font-weight: 400; text-align: left; box-sizing: content-box; direction: ltr; }
li div { padding-top: 0px; }
blockquote { margin: 1rem 0px; }
li .mathjax-block, li p { margin: 0.5rem 0px; }
li blockquote { margin: 1rem 0px; }
li { margin: 0px; position: relative; }
blockquote > :last-child { margin-bottom: 0px; }
blockquote > :first-child, li > :first-child { margin-top: 0px; }
.footnotes-area { color: rgb(136, 136, 136); margin-top: 0.714rem; padding-bottom: 0.143rem; white-space: normal; }
#write .footnote-line { white-space: pre-wrap; }
@media print {
  body, html { border: 1px solid transparent; height: 99%; break-after: avoid; break-before: avoid; font-variant-ligatures: no-common-ligatures; }
  #write { margin-top: 0px; border-color: transparent !important; padding-top: 0px !important; padding-bottom: 0px !important; }
  .typora-export * { print-color-adjust: exact; }
  .typora-export #write { break-after: avoid; }
  .typora-export #write::after { height: 0px; }
  .is-mac table { break-inside: avoid; }
  #write > p:nth-child(1) { margin-top: 0px; }
  .typora-export-show-outline .typora-export-sidebar { display: none; }
  figure { overflow-x: visible; }
}
.footnote-line { margin-top: 0.714em; font-size: 0.7em; }
a img, img a { cursor: pointer; }
pre.md-meta-block { font-size: 0.8rem; min-height: 0.8rem; white-space: pre-wrap; background: rgb(204, 204, 204); display: block; overflow-x: hidden; }
p > .md-image:only-child:not(.md-img-error) img, p > img:only-child { display: block; margin: auto; }
#write.first-line-indent p > .md-image:only-child:not(.md-img-error) img { left: -2em; position: relative; }
p > .md-image:only-child { display: inline-block; width: 100%; }
#write .MathJax_Display { margin: 0.8em 0px 0px; }
.md-math-block { width: 100%; }
.md-math-block:not(:empty)::after { display: none; }
.MathJax_ref { fill: currentcolor; }
[contenteditable="true"]:active, [contenteditable="true"]:focus, [contenteditable="false"]:active, [contenteditable="false"]:focus { outline: 0px; box-shadow: none; }
.md-task-list-item { position: relative; list-style-type: none; }
.task-list-item.md-task-list-item { padding-left: 0px; }
.md-task-list-item > input { position: absolute; top: 0px; left: 0px; margin-left: -1.2em; margin-top: calc(1em - 10px); border: medium; }
.math { font-size: 1rem; }
.md-toc { min-height: 3.58rem; position: relative; font-size: 0.9rem; border-radius: 10px; }
.md-toc-content { position: relative; margin-left: 0px; }
.md-toc-content::after, .md-toc::after { display: none; }
.md-toc-item { display: block; color: rgb(65, 131, 196); }
.md-toc-item a { text-decoration: none; }
.md-toc-inner:hover { text-decoration: underline; }
.md-toc-inner { display: inline-block; cursor: pointer; }
.md-toc-h1 .md-toc-inner { margin-left: 0px; font-weight: 700; }
.md-toc-h2 .md-toc-inner { margin-left: 2em; }
.md-toc-h3 .md-toc-inner { margin-left: 4em; }
.md-toc-h4 .md-toc-inner { margin-left: 6em; }
.md-toc-h5 .md-toc-inner { margin-left: 8em; }
.md-toc-h6 .md-toc-inner { margin-left: 10em; }
@media screen and (max-width: 48em) {
  .md-toc-h3 .md-toc-inner { margin-left: 3.5em; }
  .md-toc-h4 .md-toc-inner { margin-left: 5em; }
  .md-toc-h5 .md-toc-inner { margin-left: 6.5em; }
  .md-toc-h6 .md-toc-inner { margin-left: 8em; }
}
a.md-toc-inner { font-size: inherit; font-style: inherit; font-weight: inherit; line-height: inherit; }
.footnote-line a:not(.reversefootnote) { color: inherit; }
.reversefootnote { font-family: ui-monospace, sans-serif; }
.md-attr { display: none; }
.md-fn-count::after { content: "."; }
code, pre, samp, tt { font-family: var(--monospace); }
kbd { margin: 0px 0.1em; padding: 0.1em 0.6em; font-size: 0.8em; color: rgb(36, 39, 41); background: rgb(255, 255, 255); border: 1px solid rgb(173, 179, 185); border-radius: 3px; box-shadow: rgba(12, 13, 14, 0.2) 0px 1px 0px, rgb(255, 255, 255) 0px 0px 0px 2px inset; white-space: nowrap; vertical-align: middle; }
.md-comment { color: rgb(162, 127, 3); opacity: 0.6; font-family: var(--monospace); }
code { text-align: left; vertical-align: initial; }
a.md-print-anchor { white-space: pre !important; border-width: medium !important; border-style: none !important; border-color: currentcolor !important; display: inline-block !important; position: absolute !important; width: 1px !important; right: 0px !important; outline: 0px !important; background: 0px 0px !important; text-decoration: initial !important; text-shadow: initial !important; }
.os-windows.monocolor-emoji .md-emoji { font-family: "Segoe UI Symbol", sans-serif; }
.md-diagram-panel > svg { max-width: 100%; }
[lang="flow"] svg, [lang="mermaid"] svg { max-width: 100%; height: auto; }
[lang="mermaid"] .node text { font-size: 1rem; }
table tr th { border-bottom-width: 0px; border-bottom-style: none; border-bottom-color: currentcolor; }
video { max-width: 100%; display: block; margin: 0px auto; }
iframe { max-width: 100%; width: 100%; border: medium; }
.highlight td, .highlight tr { border: 0px; }
mark { background: rgb(255, 255, 0); color: rgb(0, 0, 0); }
.md-html-inline .md-plain, .md-html-inline strong, mark .md-inline-math, mark strong { color: inherit; }
.md-expand mark .md-meta { opacity: 0.3 !important; }
mark .md-meta { color: rgb(0, 0, 0); }
@media print {
  .typora-export h1, .typora-export h2, .typora-export h3, .typora-export h4, .typora-export h5, .typora-export h6 { break-inside: avoid; }
}
.md-diagram-panel .messageText { stroke: none !important; }
.md-diagram-panel .start-state { fill: var(--node-fill); }
.md-diagram-panel .edgeLabel rect { opacity: 1 !important; }
.md-fences.md-fences-math { font-size: 1em; }
.md-fences-advanced:not(.md-focus) { padding: 0px; white-space: nowrap; border: 0px; }
.md-fences-advanced:not(.md-focus) { background: inherit; }
.typora-export-show-outline .typora-export-content { max-width: 1440px; margin: auto; display: flex; flex-direction: row; }
.typora-export-sidebar { width: 300px; font-size: 0.8rem; margin-top: 80px; margin-right: 18px; }
.typora-export-show-outline #write { --webkit-flex: 2; flex: 2 1 0%; }
.typora-export-sidebar .outline-content { position: fixed; top: 0px; max-height: 100%; overflow: hidden auto; padding-bottom: 30px; padding-top: 60px; width: 300px; }
@media screen and (max-width: 1024px) {
  .typora-export-sidebar, .typora-export-sidebar .outline-content { width: 240px; }
}
@media screen and (max-width: 800px) {
  .typora-export-sidebar { display: none; }
}
.outline-content li, .outline-content ul { margin-left: 0px; margin-right: 0px; padding-left: 0px; padding-right: 0px; list-style: none; overflow-wrap: anywhere; }
.outline-content ul { margin-top: 0px; margin-bottom: 0px; }
.outline-content strong { font-weight: 400; }
.outline-expander { width: 1rem; height: 1.428571rem; position: relative; display: table-cell; vertical-align: middle; cursor: pointer; padding-left: 4px; }
.outline-expander::before { content: ""; position: relative; font-family: Ionicons; display: inline-block; font-size: 8px; vertical-align: middle; }
.outline-item { padding-top: 3px; padding-bottom: 3px; cursor: pointer; }
.outline-expander:hover::before { content: ""; }
.outline-h1 > .outline-item { padding-left: 0px; }
.outline-h2 > .outline-item { padding-left: 1em; }
.outline-h3 > .outline-item { padding-left: 2em; }
.outline-h4 > .outline-item { padding-left: 3em; }
.outline-h5 > .outline-item { padding-left: 4em; }
.outline-h6 > .outline-item { padding-left: 5em; }
.outline-label { cursor: pointer; display: table-cell; vertical-align: middle; text-decoration: none; color: inherit; }
.outline-label:hover { text-decoration: underline; }
.outline-item:hover { border-color: rgb(245, 245, 245); background-color: var(--item-hover-bg-color); }
.outline-item:hover { margin-left: -28px; margin-right: -28px; border-left-width: 28px; border-left-style: solid; border-left-color: transparent; border-right-width: 28px; border-right-style: solid; border-right-color: transparent; }
.outline-item-single .outline-expander::before, .outline-item-single .outline-expander:hover::before { display: none; }
.outline-item-open > .outline-item > .outline-expander::before { content: ""; }
.outline-children { display: none; }
.info-panel-tab-wrapper { display: none; }
.outline-item-open > .outline-children { display: block; }
.typora-export .outline-item { padding-top: 1px; padding-bottom: 1px; }
.typora-export .outline-item:hover { margin-right: -8px; border-right-width: 8px; border-right-style: solid; border-right-color: transparent; }
.typora-export .outline-expander::before { content: "+"; font-family: inherit; top: -1px; }
.typora-export .outline-expander:hover::before, .typora-export .outline-item-open > .outline-item > .outline-expander::before { content: "−"; }
.typora-export-collapse-outline .outline-children { display: none; }
.typora-export-collapse-outline .outline-item-open > .outline-children, .typora-export-no-collapse-outline .outline-children { display: block; }
.typora-export-no-collapse-outline .outline-expander::before { content: "" !important; }
.typora-export-show-outline .outline-item-active > .outline-item .outline-label { font-weight: 700; }
.md-inline-math-container mjx-container { zoom: 0.95; }
mjx-container { break-inside: avoid; }


.CodeMirror { height: auto; }
.CodeMirror.cm-s-inner { background: inherit; }
.CodeMirror-scroll { overflow: auto hidden; z-index: 3; }
.CodeMirror-gutter-filler, .CodeMirror-scrollbar-filler { background-color: rgb(255, 255, 255); }
.CodeMirror-gutters { border-right-width: 1px; border-right-style: solid; border-right-color: rgb(221, 221, 221); background: inherit; white-space: nowrap; }
.CodeMirror-linenumber { padding: 0px 3px 0px 5px; text-align: right; color: rgb(153, 153, 153); }
.cm-s-inner .cm-keyword { color: rgb(119, 0, 136); }
.cm-s-inner .cm-atom, .cm-s-inner.cm-atom { color: rgb(34, 17, 153); }
.cm-s-inner .cm-number { color: rgb(17, 102, 68); }
.cm-s-inner .cm-def { color: rgb(0, 0, 255); }
.cm-s-inner .cm-variable { color: rgb(0, 0, 0); }
.cm-s-inner .cm-variable-2 { color: rgb(0, 85, 170); }
.cm-s-inner .cm-variable-3 { color: rgb(0, 136, 85); }
.cm-s-inner .cm-string { color: rgb(170, 17, 17); }
.cm-s-inner .cm-property { color: rgb(0, 0, 0); }
.cm-s-inner .cm-operator { color: rgb(152, 26, 26); }
.cm-s-inner .cm-comment, .cm-s-inner.cm-comment { color: rgb(170, 85, 0); }
.cm-s-inner .cm-string-2 { color: rgb(255, 85, 0); }
.cm-s-inner .cm-meta { color: rgb(85, 85, 85); }
.cm-s-inner .cm-qualifier { color: rgb(85, 85, 85); }
.cm-s-inner .cm-builtin { color: rgb(51, 0, 170); }
.cm-s-inner .cm-bracket { color: rgb(153, 153, 119); }
.cm-s-inner .cm-tag { color: rgb(17, 119, 0); }
.cm-s-inner .cm-attribute { color: rgb(0, 0, 204); }
.cm-s-inner .cm-header, .cm-s-inner.cm-header { color: rgb(0, 0, 255); }
.cm-s-inner .cm-quote, .cm-s-inner.cm-quote { color: rgb(0, 153, 0); }
.cm-s-inner .cm-hr, .cm-s-inner.cm-hr { color: rgb(153, 153, 153); }
.cm-s-inner .cm-link, .cm-s-inner.cm-link { color: rgb(0, 0, 204); }
.cm-negative { color: rgb(221, 68, 68); }
.cm-positive { color: rgb(34, 153, 34); }
.cm-header, .cm-strong { font-weight: 700; }
.cm-del { text-decoration: line-through; }
.cm-em { font-style: italic; }
.cm-link { text-decoration: underline; }
.cm-error { color: red; }
.cm-invalidchar { color: red; }
.cm-constant { color: rgb(38, 139, 210); }
.cm-defined { color: rgb(181, 137, 0); }
div.CodeMirror span.CodeMirror-matchingbracket { color: rgb(0, 255, 0); }
div.CodeMirror span.CodeMirror-nonmatchingbracket { color: rgb(255, 34, 34); }
.cm-s-inner .CodeMirror-activeline-background { background: inherit; }
.CodeMirror { position: relative; overflow: hidden; }
.CodeMirror-scroll { height: 100%; outline: 0px; position: relative; box-sizing: content-box; background: inherit; }
.CodeMirror-sizer { position: relative; }
.CodeMirror-gutter-filler, .CodeMirror-hscrollbar, .CodeMirror-scrollbar-filler, .CodeMirror-vscrollbar { position: absolute; z-index: 6; display: none; outline: 0px; }
.CodeMirror-vscrollbar { right: 0px; top: 0px; overflow: hidden; }
.CodeMirror-hscrollbar { bottom: 0px; left: 0px; overflow: auto hidden; }
.CodeMirror-scrollbar-filler { right: 0px; bottom: 0px; }
.CodeMirror-gutter-filler { left: 0px; bottom: 0px; }
.CodeMirror-gutters { position: absolute; left: 0px; top: 0px; padding-bottom: 10px; z-index: 3; overflow-y: hidden; }
.CodeMirror-gutter { white-space: normal; height: 100%; box-sizing: content-box; padding-bottom: 30px; margin-bottom: -32px; display: inline-block; }
.CodeMirror-gutter-wrapper { position: absolute; z-index: 4; background: 0px 0px !important; border: medium !important; }
.CodeMirror-gutter-background { position: absolute; top: 0px; bottom: 0px; z-index: 4; }
.CodeMirror-gutter-elt { position: absolute; cursor: default; z-index: 4; }
.CodeMirror-lines { cursor: text; }
.CodeMirror pre { border-radius: 0px; border-width: 0px; background: 0px 0px; font-family: inherit; font-size: inherit; margin: 0px; white-space: pre; overflow-wrap: normal; color: inherit; z-index: 2; position: relative; overflow: visible; }
.CodeMirror-wrap pre { overflow-wrap: break-word; white-space: pre-wrap; word-break: normal; }
.CodeMirror-code pre { border-right-width: 30px; border-right-style: solid; border-right-color: transparent; width: fit-content; }
.CodeMirror-wrap .CodeMirror-code pre { border-right-width: medium; border-right-style: none; border-right-color: currentcolor; width: auto; }
.CodeMirror-linebackground { position: absolute; inset: 0px; z-index: 0; }
.CodeMirror-linewidget { position: relative; z-index: 2; overflow: auto; }
.CodeMirror-wrap .CodeMirror-scroll { overflow-x: hidden; }
.CodeMirror-measure { position: absolute; width: 100%; height: 0px; overflow: hidden; visibility: hidden; }
.CodeMirror-measure pre { position: static; }
.CodeMirror div.CodeMirror-cursor { position: absolute; visibility: hidden; border-right-width: medium; border-right-style: none; border-right-color: currentcolor; width: 0px; }
.CodeMirror div.CodeMirror-cursor { visibility: hidden; }
.CodeMirror-focused div.CodeMirror-cursor { visibility: inherit; }
.cm-searching { background: rgba(255, 255, 0, 0.4); }
span.cm-underlined { text-decoration: underline; }
span.cm-strikethrough { text-decoration: line-through; }
.cm-tw-syntaxerror { color: rgb(255, 255, 255); background-color: rgb(153, 0, 0); }
.cm-tw-deleted { text-decoration: line-through; }
.cm-tw-header5 { font-weight: 700; }
.cm-tw-listitem:first-child { padding-left: 10px; }
.cm-tw-box { border-style: solid; border-right-width: 1px; border-bottom-width: 1px; border-left-width: 1px; border-color: inherit; border-top-width: 0px !important; }
.cm-tw-underline { text-decoration: underline; }
@media print {
  .CodeMirror div.CodeMirror-cursor { visibility: hidden; }
}


:root {
    --side-bar-bg-color: #fafafa;
    --control-text-color: #777;
}

@include-when-export url(https://fonts.googleapis.com/css?family=Open+Sans:400italic,700italic,700,400&subset=latin,latin-ext);

/* open-sans-regular - latin-ext_latin */
  /* open-sans-italic - latin-ext_latin */
    /* open-sans-700 - latin-ext_latin */
    /* open-sans-700italic - latin-ext_latin */
  html {
    font-size: 16px;
    -webkit-font-smoothing: antialiased;
}

body {
    font-family: "Open Sans","Clear Sans", "Helvetica Neue", Helvetica, Arial, 'Segoe UI Emoji', sans-serif;
    color: rgb(51, 51, 51);
    line-height: 1.6;
}

#write {
    max-width: 860px;
  	margin: 0 auto;
  	padding: 30px;
    padding-bottom: 100px;
}

@media only screen and (min-width: 1400px) {
	#write {
		max-width: 1024px;
	}
}

@media only screen and (min-width: 1800px) {
	#write {
		max-width: 1200px;
	}
}

#write > ul:first-child,
#write > ol:first-child{
    margin-top: 30px;
}

a {
    color: #4183C4;
}
h1,
h2,
h3,
h4,
h5,
h6 {
    position: relative;
    margin-top: 1rem;
    margin-bottom: 1rem;
    font-weight: bold;
    line-height: 1.4;
    cursor: text;
}
h1:hover a.anchor,
h2:hover a.anchor,
h3:hover a.anchor,
h4:hover a.anchor,
h5:hover a.anchor,
h6:hover a.anchor {
    text-decoration: none;
}
h1 tt,
h1 code {
    font-size: inherit;
}
h2 tt,
h2 code {
    font-size: inherit;
}
h3 tt,
h3 code {
    font-size: inherit;
}
h4 tt,
h4 code {
    font-size: inherit;
}
h5 tt,
h5 code {
    font-size: inherit;
}
h6 tt,
h6 code {
    font-size: inherit;
}
h1 {
    font-size: 2.25em;
    line-height: 1.2;
    border-bottom: 1px solid #eee;
}
h2 {
    font-size: 1.75em;
    line-height: 1.225;
    border-bottom: 1px solid #eee;
}

/*@media print {
    .typora-export h1,
    .typora-export h2 {
        border-bottom: none;
        padding-bottom: initial;
    }

    .typora-export h1::after,
    .typora-export h2::after {
        content: "";
        display: block;
        height: 100px;
        margin-top: -96px;
        border-top: 1px solid #eee;
    }
}*/

h3 {
    font-size: 1.5em;
    line-height: 1.43;
}
h4 {
    font-size: 1.25em;
}
h5 {
    font-size: 1em;
}
h6 {
   font-size: 1em;
    color: #777;
}
p,
blockquote,
ul,
ol,
dl,
table{
    margin: 0.8em 0;
}
li>ol,
li>ul {
    margin: 0 0;
}
hr {
    height: 2px;
    padding: 0;
    margin: 16px 0;
    background-color: #e7e7e7;
    border: 0 none;
    overflow: hidden;
    box-sizing: content-box;
}

li p.first {
    display: inline-block;
}
ul,
ol {
    padding-left: 30px;
}
ul:first-child,
ol:first-child {
    margin-top: 0;
}
ul:last-child,
ol:last-child {
    margin-bottom: 0;
}
blockquote {
    border-left: 4px solid #dfe2e5;
    padding: 0 15px;
    color: #777777;
}
blockquote blockquote {
    padding-right: 0;
}
table {
    padding: 0;
    word-break: initial;
}
table tr {
    border: 1px solid #dfe2e5;
    margin: 0;
    padding: 0;
}
table tr:nth-child(2n),
thead {
    background-color: #f8f8f8;
}
table th {
    font-weight: bold;
    border: 1px solid #dfe2e5;
    border-bottom: 0;
    margin: 0;
    padding: 6px 13px;
}
table td {
    border: 1px solid #dfe2e5;
    margin: 0;
    padding: 6px 13px;
}
table th:first-child,
table td:first-child {
    margin-top: 0;
}
table th:last-child,
table td:last-child {
    margin-bottom: 0;
}

.CodeMirror-lines {
    padding-left: 4px;
}

.code-tooltip {
    box-shadow: 0 1px 1px 0 rgba(0,28,36,.3);
    border-top: 1px solid #eef2f2;
}

.md-fences,
code,
tt {
    border: 1px solid #e7eaed;
    background-color: #f8f8f8;
    border-radius: 3px;
    padding: 0;
    padding: 2px 4px 0px 4px;
    font-size: 0.9em;
}

code {
    background-color: #f3f4f4;
    padding: 0 2px 0 2px;
}

.md-fences {
    margin-bottom: 15px;
    margin-top: 15px;
    padding-top: 8px;
    padding-bottom: 6px;
}


.md-task-list-item > input {
  margin-left: -1.3em;
}

@media print {
    html {
        font-size: 13px;
    }
    pre {
        page-break-inside: avoid;
        word-wrap: break-word;
    }
}

.md-fences {
	background-color: #f8f8f8;
}
#write pre.md-meta-block {
	padding: 1rem;
    font-size: 85%;
    line-height: 1.45;
    background-color: #f7f7f7;
    border: 0;
    border-radius: 3px;
    color: #777777;
    margin-top: 0 !important;
}

.mathjax-block>.code-tooltip {
	bottom: .375rem;
}

.md-mathjax-midline {
    background: #fafafa;
}

#write>h3.md-focus:before{
	left: -1.5625rem;
	top: .375rem;
}
#write>h4.md-focus:before{
	left: -1.5625rem;
	top: .285714286rem;
}
#write>h5.md-focus:before{
	left: -1.5625rem;
	top: .285714286rem;
}
#write>h6.md-focus:before{
	left: -1.5625rem;
	top: .285714286rem;
}
.md-image>.md-meta {
    /*border: 1px solid #ddd;*/
    border-radius: 3px;
    padding: 2px 0px 0px 4px;
    font-size: 0.9em;
    color: inherit;
}

.md-tag {
    color: #a7a7a7;
    opacity: 1;
}

.md-toc { 
    margin-top:20px;
    padding-bottom:20px;
}

.sidebar-tabs {
    border-bottom: none;
}

#typora-quick-open {
    border: 1px solid #ddd;
    background-color: #f8f8f8;
}

#typora-quick-open-item {
    background-color: #FAFAFA;
    border-color: #FEFEFE #e5e5e5 #e5e5e5 #eee;
    border-style: solid;
    border-width: 1px;
}

/** focus mode */
.on-focus-mode blockquote {
    border-left-color: rgba(85, 85, 85, 0.12);
}

header, .context-menu, .megamenu-content, footer{
    font-family: "Segoe UI", "Arial", sans-serif;
}

.file-node-content:hover .file-node-icon,
.file-node-content:hover .file-node-open-state{
    visibility: visible;
}

.mac-seamless-mode #typora-sidebar {
    background-color: #fafafa;
    background-color: var(--side-bar-bg-color);
}

.md-lang {
    color: #b4654d;
}

/*.html-for-mac {
    --item-hover-bg-color: #E6F0FE;
}*/

#md-notification .btn {
    border: 0;
}

.dropdown-menu .divider {
    border-color: #e5e5e5;
    opacity: 0.4;
}

.ty-preferences .window-content {
    background-color: #fafafa;
}

.ty-preferences .nav-group-item.active {
    color: white;
    background: #999;
}

.menu-item-container a.menu-style-btn {
    background-color: #f5f8fa;
    background-image: linear-gradient( 180deg , hsla(0, 0%, 100%, 0.8), hsla(0, 0%, 100%, 0)); 
}


 @media print { @page {margin: 0 0 0 0;} body.typora-export {padding-left: 0; padding-right: 0;} #write {padding:0;}} .typora-export li, .typora-export p, .typora-export,  .footnote-line {white-space: normal;} h1,h2,h3,h4,h5 {white-space:pre-line}
</style><title>diffusers调研</title>
</head>
<body class='typora-export typora-export-show-outline typora-export-no-collapse-outline'><div class='typora-export-content'>
<div class="typora-export-sidebar"><div class="outline-content"><li class="outline-item-wrapper outline-h2"><div class="outline-item"><span class="outline-expander"></span><a class="outline-label" href="#🤗--d🧨-ffusers调研">🤗  D🧨 ffusers调研</a></div><ul class="outline-children"></ul></li><li class="outline-item-wrapper outline-h2"><div class="outline-item"><span class="outline-expander"></span><a class="outline-label" href="#stable-diffusion基本概念与原理">Stable Diffusion基本概念与原理</a></div><ul class="outline-children"><li class="outline-item-wrapper outline-h3"><div class="outline-item"><span class="outline-expander"></span><a class="outline-label" href="#clip-text-encoder">CLIP text-encoder</a></div><ul class="outline-children"></ul></li><li class="outline-item-wrapper outline-h3"><div class="outline-item"><span class="outline-expander"></span><a class="outline-label" href="#模型">模型</a></div><ul class="outline-children"></ul></li><li class="outline-item-wrapper outline-h3"><div class="outline-item"><span class="outline-expander"></span><a class="outline-label" href="#采样器">采样器</a></div><ul class="outline-children"></ul></li><li class="outline-item-wrapper outline-h3"><div class="outline-item"><span class="outline-expander"></span><a class="outline-label" href="#vae">VAE</a></div><ul class="outline-children"></ul></li></ul></li><li class="outline-item-wrapper outline-h2"><div class="outline-item"><span class="outline-expander"></span><a class="outline-label" href="#diffusers库">diffusers库</a></div><ul class="outline-children"><li class="outline-item-wrapper outline-h3"><div class="outline-item"><span class="outline-expander"></span><a class="outline-label" href="#简单的实例">简单的实例</a></div><ul class="outline-children"></ul></li><li class="outline-item-wrapper outline-h3"><div class="outline-item"><span class="outline-expander"></span><a class="outline-label" href="#概念schedulers-与-models">概念：Schedulers 与 Models </a></div><ul class="outline-children"></ul></li></ul></li><li class="outline-item-wrapper outline-h2"><div class="outline-item"><span class="outline-expander"></span><a class="outline-label" href="#diffusers代码结构">diffusers代码结构</a></div><ul class="outline-children"></ul></li><li class="outline-item-wrapper outline-h2"><div class="outline-item"><span class="outline-expander"></span><a class="outline-label" href="#diffusers核心逻辑">diffusers核心逻辑</a></div><ul class="outline-children"><li class="outline-item-wrapper outline-h3"><div class="outline-item"><span class="outline-expander"></span><a class="outline-label" href="#stable-diffusion加载模型初始化-pipeline">Stable Diffusion加载模型、初始化 pipeline</a></div><ul class="outline-children"><li class="outline-item-wrapper outline-h4"><div class="outline-item"><span class="outline-expander"></span><a class="outline-label" href="#diffusionpipelinefrompretrained">DiffusionPipeline.from_pretrained()</a></div><ul class="outline-children"></ul></li><li class="outline-item-wrapper outline-h4"><div class="outline-item"><span class="outline-expander"></span><a class="outline-label" href="#fromcpkt">from_cpkt</a></div><ul class="outline-children"></ul></li></ul></li><li class="outline-item-wrapper outline-h3"><div class="outline-item"><span class="outline-expander"></span><a class="outline-label" href="#pipeline执行推理">pipeline()执行推理 </a></div><ul class="outline-children"></ul></li></ul></li><li class="outline-item-wrapper outline-h2"><div class="outline-item"><span class="outline-expander"></span><a class="outline-label" href="#如何生成与stable-diffusion-webui相同的结果">如何生成与stable-diffusion-webui相同的结果</a></div><ul class="outline-children"><li class="outline-item-wrapper outline-h3"><div class="outline-item"><span class="outline-expander"></span><a class="outline-label" href="#基本功能">基本功能</a></div><ul class="outline-children"></ul></li><li class="outline-item-wrapper outline-h3"><div class="outline-item"><span class="outline-expander"></span><a class="outline-label" href="#复杂一些的提示词">复杂一些的提示词</a></div><ul class="outline-children"></ul></li><li class="outline-item-wrapper outline-h3"><div class="outline-item"><span class="outline-expander"></span><a class="outline-label" href="#lora支持">LoRA支持</a></div><ul class="outline-children"><li class="outline-item-wrapper outline-h4"><div class="outline-item"><span class="outline-expander"></span><a class="outline-label" href="#单lora支持">单LoRA支持</a></div><ul class="outline-children"></ul></li><li class="outline-item-wrapper outline-h4"><div class="outline-item"><span class="outline-expander"></span><a class="outline-label" href="#多lora支持">多LoRA支持</a></div><ul class="outline-children"></ul></li></ul></li><li class="outline-item-wrapper outline-h3"><div class="outline-item"><span class="outline-expander"></span><a class="outline-label" href="#面部修复---codeformer">面部修复 - CodeFormer</a></div><ul class="outline-children"></ul></li><li class="outline-item-wrapper outline-h3"><div class="outline-item"><span class="outline-expander"></span><a class="outline-label" href="#hiresfix">Hires.fix</a></div><ul class="outline-children"><li class="outline-item-wrapper outline-h4"><div class="outline-item"><span class="outline-expander"></span><a class="outline-label" href="#sd-webui是如何实现hiresfix的">sd webui是如何实现Hires.fix的?</a></div><ul class="outline-children"></ul></li><li class="outline-item-wrapper outline-h4"><div class="outline-item"><span class="outline-expander"></span><a class="outline-label" href="#diffusers中应该如何实现">diffusers中应该如何实现</a></div><ul class="outline-children"></ul></li></ul></li><li class="outline-item-wrapper outline-h3"><div class="outline-item"><span class="outline-expander"></span><a class="outline-label" href="#相对于sd-webui的优缺点">相对于sd webui的优缺点</a></div><ul class="outline-children"></ul></li></ul></li><li class="outline-item-wrapper outline-h2"><div class="outline-item"><span class="outline-expander"></span><a class="outline-label" href="#写在最后">写在最后</a></div><ul class="outline-children"></ul></li><li class="outline-item-wrapper outline-h2"><div class="outline-item"><span class="outline-expander"></span><a class="outline-label" href="#附1-stable-diffusion-webui--diffusers安装">附1 stable diffusion webui &amp;&amp; diffusers安装</a></div><ul class="outline-children"></ul></li><li class="outline-item-wrapper outline-h2"><div class="outline-item"><span class="outline-expander"></span><a class="outline-label" href="#附2-开发环境">附2 开发环境</a></div><ul class="outline-children"></ul></li><li class="outline-item-wrapper outline-h2"><div class="outline-item"><span class="outline-expander"></span><a class="outline-label" href="#附3-一些参考链接">附3 一些参考链接</a></div><ul class="outline-children"></ul></li></div></div><div id='write'  class=' first-line-indent'><h2 id='🤗--d🧨-ffusers调研'><span>🤗  D🧨 ffusers调研</span></h2><blockquote><p><span>由于本人非算法背景、本文未描述任何算法原理、尽管如此，还是会有很多地方说的可能不正确，有任何问题都欢迎指正。</span></p></blockquote><div class='md-toc' mdtype='toc'><p class="md-toc-content" role="list"><span role="listitem" class="md-toc-item md-toc-h2" data-ref="n1367"><a class="md-toc-inner" href="#🤗--d🧨-ffusers调研">🤗  D🧨 ffusers调研</a></span><span role="listitem" class="md-toc-item md-toc-h2" data-ref="n1372"><a class="md-toc-inner" href="#stable-diffusion基本概念与原理">Stable Diffusion基本概念与原理</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n1389"><a class="md-toc-inner" href="#clip-text-encoder">CLIP text-encoder</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n1397"><a class="md-toc-inner" href="#模型">模型</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n1401"><a class="md-toc-inner" href="#采样器">采样器</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n1403"><a class="md-toc-inner" href="#vae">VAE</a></span><span role="listitem" class="md-toc-item md-toc-h2" data-ref="n1409"><a class="md-toc-inner" href="#diffusers库">diffusers库</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n1422"><a class="md-toc-inner" href="#简单的实例">简单的实例</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n1424"><a class="md-toc-inner" href="#概念schedulers-与-models">概念：Schedulers 与 Models </a></span><span role="listitem" class="md-toc-item md-toc-h2" data-ref="n1431"><a class="md-toc-inner" href="#diffusers代码结构">diffusers代码结构</a></span><span role="listitem" class="md-toc-item md-toc-h2" data-ref="n1434"><a class="md-toc-inner" href="#diffusers核心逻辑">diffusers核心逻辑</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n1435"><a class="md-toc-inner" href="#stable-diffusion加载模型初始化-pipeline">Stable Diffusion加载模型、初始化 pipeline</a></span><span role="listitem" class="md-toc-item md-toc-h4" data-ref="n1436"><a class="md-toc-inner" href="#diffusionpipelinefrompretrained">DiffusionPipeline.from_pretrained()</a></span><span role="listitem" class="md-toc-item md-toc-h4" data-ref="n1455"><a class="md-toc-inner" href="#fromcpkt">from_cpkt</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n1458"><a class="md-toc-inner" href="#pipeline执行推理">pipeline()执行推理 </a></span><span role="listitem" class="md-toc-item md-toc-h2" data-ref="n1475"><a class="md-toc-inner" href="#如何生成与stable-diffusion-webui相同的结果">如何生成与stable-diffusion-webui相同的结果</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n1484"><a class="md-toc-inner" href="#基本功能">基本功能</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n1488"><a class="md-toc-inner" href="#复杂一些的提示词">复杂一些的提示词</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n1512"><a class="md-toc-inner" href="#lora支持">LoRA支持</a></span><span role="listitem" class="md-toc-item md-toc-h4" data-ref="n1513"><a class="md-toc-inner" href="#单lora支持">单LoRA支持</a></span><span role="listitem" class="md-toc-item md-toc-h4" data-ref="n1528"><a class="md-toc-inner" href="#多lora支持">多LoRA支持</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n1530"><a class="md-toc-inner" href="#面部修复---codeformer">面部修复 - CodeFormer</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n1536"><a class="md-toc-inner" href="#hiresfix">Hires.fix</a></span><span role="listitem" class="md-toc-item md-toc-h4" data-ref="n1540"><a class="md-toc-inner" href="#sd-webui是如何实现hiresfix的">sd webui是如何实现Hires.fix的?</a></span><span role="listitem" class="md-toc-item md-toc-h4" data-ref="n1559"><a class="md-toc-inner" href="#diffusers中应该如何实现">diffusers中应该如何实现</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n1562"><a class="md-toc-inner" href="#相对于sd-webui的优缺点">相对于sd webui的优缺点</a></span><span role="listitem" class="md-toc-item md-toc-h2" data-ref="n1567"><a class="md-toc-inner" href="#写在最后">写在最后</a></span><span role="listitem" class="md-toc-item md-toc-h2" data-ref="n1571"><a class="md-toc-inner" href="#附1-stable-diffusion-webui--diffusers安装">附1 stable diffusion webui &amp;&amp; diffusers安装</a></span><span role="listitem" class="md-toc-item md-toc-h2" data-ref="n1575"><a class="md-toc-inner" href="#附2-开发环境">附2 开发环境</a></span><span role="listitem" class="md-toc-item md-toc-h2" data-ref="n1577"><a class="md-toc-inner" href="#附3-一些参考链接">附3 一些参考链接</a></span></p></div><p>&nbsp;</p><h2 id='stable-diffusion基本概念与原理'><span>Stable Diffusion基本概念与原理</span></h2><p><img src="http://devops-1255386119.cos.ap-beijing.myqcloud.com/2023-07-13-053448.png" referrerpolicy="no-referrer" alt="sd-pipeline"></p><p><span>文生推理阶段主要流程：</span></p><ol start='' ><li><p><span>生成一个随机的噪声，外加根据prompt生成prompt_embeds；</span></p></li><li><p><span>Stable Diffusion的核心逻辑是一个循环，每个循环将降低一些图像的噪声，将图像变的更清晰。其中每个循环：</span></p></li></ol><ul><li><p><span>将图像A和clip prompt_embeds输入模型预测噪声残差，然后将噪声残差、图像 A、step_no 输入采样器预测更清晰的图像B;</span></p></li><li><p><span>将图像B和clip prompt_embeds输入模型预测噪声残差..循环N次,得到图像C</span></p></li></ul><ol start='3' ><li><p><span>最终将图像 C 输入 VAE 模型,得到更加清晰的图像。</span></p></li></ol><p><span>以下是对涉及模块的通俗解释。</span></p><h3 id='clip-text-encoder'><span>CLIP text-encoder</span></h3><p><span>说白了，就是将prompt转换成prompt_embeds，而这个prompt_embeds可包含图像特征。</span></p><blockquote><p><span>CLIP 是一个多模态学习框架，涉及到同时训练文本编码器和图像编码器。这种联合训练有助于让文本编码器和图像编码器之间共享相同的语义空间。这使得当我们从文本编码器得到文本的向量表示时，能够与图像编码器生成的图像向量进行直接比较。</span></p><p><span>得益于这种联合训练，CLIP 文本编码器可以广泛应用于各种自然语言处理和多模态学习任务，比如图像分类、图像检索、图像生成等。通过利用文本编码器生成的文本向量表示，模型能更好地关联文本和图像信息，从而在这些任务中实现高性能。            </span></p><p><span>-- GPT4生成内容</span></p></blockquote><blockquote><p><span>Inspired by </span><a href='https://imagen.research.google/'><span>Imagen</span></a><span>, Stable Diffusion does </span><strong><span>not</span></strong><span> train the text-encoder during training and simply uses an CLIP&#39;s already trained text encoder, </span><a href='https://huggingface.co/docs/transformers/model_doc/clip#transformers.CLIPTextModel'><span>CLIPTextModel</span></a><span>.             --- </span><a href='https://colab.research.google.com/github/huggingface/notebooks/blob/main/diffusers/diffusers_intro.ipynb'><span>diffusers_intro colab</span></a></p></blockquote><h3 id='模型'><span>模型</span></h3><p><span>将prompt_embeds，带噪声的图像 输入模型 推理得到 噪声残差。即 model(prompt_embeds, 带噪声的图像) =  噪声残差</span></p><blockquote><p><span>Without going in too much detail, the model is usually not trained to directly predict a slightly less noisy image, but rather to predict the &quot;noise residual&quot; which is the difference between a less noisy image and the input image (for a diffusion model called &quot;DDPM&quot;) or, similarly, the gradient between the two time steps (like the diffusion model called &quot;Score VE&quot;). </span></p></blockquote><h3 id='采样器'><span>采样器</span></h3><p><span>将噪声残差、图像 、推理步骤数 输入采样器预测更清晰的图像; 即sample(噪声残差, 推理步骤数, 带噪声的图像) = 更清晰的图像</span></p><h3 id='vae'><span>VAE</span></h3><p><span>可以理解为一种压缩算法、encode 就是压缩、尽可能保留图像特征的同时压缩图片的大小，这样处理更快、更节省资源；decode 就是解压缩、恢复成原有的图片； 这是latent diffusion又快又高效的关键所在。</span></p><blockquote><p><span>The VAE model has two parts, an encoder and a decoder. The encoder is used to convert the image into a low dimensional latent representation, which will serve as the input to the U-Net model. The decoder, conversely, transforms the latent representation back into an image.</span></p><p><span>Since latent diffusion operates on a low dimensional space, it greatly reduces the memory and compute requirements compared to pixel-space diffusion models. For example, the autoencoder used in Stable Diffusion has a reduction factor of 8. This means that an image of shape </span><code>(3, 512, 512)</code><span> becomes </span><code>(3, 64, 64)</code><span> in latent space, which requires </span><code>8 × 8 = 64</code><span> times less memory.</span></p></blockquote><p><img src="http://devops-1255386119.cos.ap-beijing.myqcloud.com/2023-07-13-053444.png" alt="img" style="zoom:67%;" /></p><h2 id='diffusers库'><span>diffusers库</span></h2><p><span>当前aigc概念火热，ai绘画作为其中的一个分支，随着stable diffusion的开源，大家纷纷开始</span><strong><span>自研</span></strong><span>。目前比较热门的开源项目有：</span></p><p><a href='https://github.com/AUTOMATIC1111/stable-diffusion-webui'><span>Automatic1111 Stable Diffusion WebUI</span></a></p><p><a href='https://github.com/comfyanonymous/ComfyUI'><span>ComfyUI</span></a></p><p><a href='https://github.com/invoke-ai/InvokeAI'><span>InvokeAI</span></a></p><p><span>其中最为火热的是</span><a href='https://github.com/AUTOMATIC1111/stable-diffusion-webui'><span>Automatic1111 Stable Diffusion WebUI</span></a><span>，功能也是最齐全的，不过代码结构和风格导致其不太合适自研(二次开发)。因此就想看有没有更适合二次开发的项目。</span></p><p><span>一种方式是像Automatic1111 Stable Diffusion WebUI一样，直接基于</span><a href='https://github.com/CompVis/stable-diffusion'><span>CompVis/stable-diffusion</span></a><span>、</span><a href='https://github.com/runwayml/stable-diffusion'><span>runwayml/stable-diffusion</span></a><span>、</span><a href='https://github.com/Stability-AI/stablediffusion'><span>Stability-AI/stablediffusion</span></a><span>、</span><a href='https://github.com/crowsonkb/k-diffusion'><span>https://github.com/crowsonkb/k-diffusion</span></a><span>等开源库进行开发，这样工作量会非常大。</span></p><p><span>而另外一种方式是基于diffusers库进行开发。</span></p><p><span>diffusers是huggingface开源的、一个diffusion models的工具库，包含unet、采样器、vae等实现，同时也支持将类似文生图、图生图的逻辑抽象成pipeline。</span></p><blockquote><p><span>🤗 Diffusers is the go-to library for state-of-the-art pretrained diffusion models for generating images, audio, and even 3D structures of molecules. </span></p></blockquote><p><span> 另外</span><a href='https://github.com/invoke-ai/InvokeAI'><span>InvokeAI</span></a><span>的后端已切换为有diffusers驱动。</span></p><p><span>以下内容主要介绍diffusers使用、原理分析以及如何复现</span><a href='https://github.com/AUTOMATIC1111/stable-diffusion-webui'><span>Automatic1111 Stable Diffusion WebUI</span></a><span>所支持的功能。</span></p><h3 id='简单的实例'><span>简单的实例</span></h3><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="python"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="python"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9.111112px; left: 7.326416px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: currentcolor;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: currentcolor;"><div class="CodeMirror-measure"><pre>x</pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">from</span> <span class="cm-variable">diffusers</span> <span class="cm-keyword">import</span> <span class="cm-variable">DiffusionPipeline</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">from</span> <span class="cm-variable">torch</span> <span class="cm-keyword">import</span> <span class="cm-variable">autocast</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 加载模型配置、初始化 pipeline</span></span></pre><div class="" style="position: relative;"><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">pipeline</span> <span class="cm-operator">=</span> <span class="cm-variable">DiffusionPipeline</span>.<span class="cm-property">from_pretrained</span>(<span class="cm-string">"runwayml/stable-diffusion-v1-5"</span>).<span class="cm-property">to</span>(<span class="cm-string">"cuda"</span>)</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">prompt</span> <span class="cm-operator">=</span> <span class="cm-string">"a photo of an astronaut riding a horse on mars"</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">with</span> <span class="cm-variable">autocast</span>(<span class="cm-string">"cuda"</span>):</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-comment"># 执行推理、StableDiffusionPipeline的__call__函数</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">image</span> <span class="cm-operator">=</span> <span class="cm-variable">pipeline</span>(<span class="cm-variable">prompt</span>)[<span class="cm-number">0</span>][<span class="cm-number">0</span>]</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">image</span>.<span class="cm-property">save</span>(<span class="cm-string">"astronaut_rides_horse.png"</span>)</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom-width: 0px; border-bottom-style: solid; border-bottom-color: transparent; top: 244px;"></div><div class="CodeMirror-gutters" style="display: none; height: 244px;"></div></div></div></pre><h3 id='概念schedulers-与-models'><span>概念：Schedulers 与 Models </span></h3><p><span>diffusers中的 models是预测残差、而 schedulers其实就是上文中所说的采样器,主要作用是增加噪声用于训练和将 models预测的残差应用到 有噪声的图像上生成更清晰的图片。(U-Net Model)</span></p><blockquote><p><strong><span>Schedulers</span></strong><span> define the noise schedule which is used to add noise to the model during training, and also define the algorithm to </span><strong><span>compute</span></strong><span> the slightly less noisy sample given the model output (here </span><code>noisy_residual</code><span>). </span></p><p><span>The model </span><strong><span>predict</span></strong><span> the noise residual or slightly less noisy image with its trained weights, while the scheduler </span><strong><span>computes</span></strong><span> the previous sample given the model&#39;s output.</span></p></blockquote><p><span>Schedulers配置参数</span></p><p><span>-</span><span> </span><code>num_train_timesteps</code><span> defines the length of the denoising process, e.g. how many timesteps are need to process random gaussian noise to a data sample.</span></p><h2 id='diffusers代码结构'><span>diffusers代码结构</span></h2><p><span>diffusers代码结构合理、简单、外部依赖少，是开发人员二次开发diffusion models的首选。</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="bash" style="break-inside: unset;"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="bash"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9.111112px; left: 7.326416px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: currentcolor;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: currentcolor;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">├── docs</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">├── examples</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">├── Makefile</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">├── MANIFEST.in</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">├── README.md</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">├── scripts</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">├── setup.py</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">├── src</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">│ &nbsp; └── diffusers</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">│ &nbsp; &nbsp; &nbsp; ├── commands</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">│ &nbsp; &nbsp; &nbsp; ├── models 模型实现相关类，如 unet、vae</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">│ &nbsp; &nbsp; &nbsp; │ &nbsp; ├── activations.py</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">│ &nbsp; &nbsp; &nbsp; │ &nbsp; ├── attention_processor.py</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">│ &nbsp; &nbsp; &nbsp; │ &nbsp; ├── attention.py</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">│ &nbsp; &nbsp; &nbsp; │ &nbsp; ├── autoencoder_kl.py</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">│ &nbsp; &nbsp; &nbsp; │ &nbsp; ├── controlnet.py</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">│ &nbsp; &nbsp; &nbsp; │ &nbsp; ├── cross_attention.py</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">│ &nbsp; &nbsp; &nbsp; │ &nbsp; ├── dual_transformer_2d.py</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">│ &nbsp; &nbsp; &nbsp; │ &nbsp; ├── embeddings.py</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">│ &nbsp; &nbsp; &nbsp; │ &nbsp; ├── __init__.py</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">│ &nbsp; &nbsp; &nbsp; │ &nbsp; ├── modeling_flax_pytorch_utils.py</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">│ &nbsp; &nbsp; &nbsp; │ &nbsp; ├── modeling_flax_utils.py</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">│ &nbsp; &nbsp; &nbsp; │ &nbsp; ├── modeling_utils.py</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">│ &nbsp; &nbsp; &nbsp; │ &nbsp; ├── prior_transformer.py</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">│ &nbsp; &nbsp; &nbsp; │ &nbsp; ├── resnet.py</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">│ &nbsp; &nbsp; &nbsp; │ &nbsp; ├── t5_film_transformer.py</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">│ &nbsp; &nbsp; &nbsp; │ &nbsp; ├── transformer_2d.py</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">│ &nbsp; &nbsp; &nbsp; │ &nbsp; ├── transformer_temporal.py</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">│ &nbsp; &nbsp; &nbsp; │ &nbsp; ├── unet_1d_blocks.py</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">│ &nbsp; &nbsp; &nbsp; │ &nbsp; ├── unet_1d.py</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">│ &nbsp; &nbsp; &nbsp; │ &nbsp; ├── unet_2d_blocks_flax.py</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">│ &nbsp; &nbsp; &nbsp; │ &nbsp; ├── unet_2d_blocks.py</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">│ &nbsp; &nbsp; &nbsp; │ &nbsp; ├── unet_2d_condition_flax.py</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">│ &nbsp; &nbsp; &nbsp; │ &nbsp; ├── unet_2d_condition.py</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">│ &nbsp; &nbsp; &nbsp; │ &nbsp; ├── unet_2d.py</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">│ &nbsp; &nbsp; &nbsp; │ &nbsp; ├── unet_3d_blocks.py</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">│ &nbsp; &nbsp; &nbsp; │ &nbsp; ├── unet_3d_condition.py</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">│ &nbsp; &nbsp; &nbsp; │ &nbsp; ├── vae.py</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">│ &nbsp; &nbsp; &nbsp; │ &nbsp; └── vq_model.py</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">│ &nbsp; &nbsp; &nbsp; ├── pipelines 任务逻辑抽象层</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">│ &nbsp; &nbsp; &nbsp; │ &nbsp; ├── audio_diffusion</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">│ &nbsp; &nbsp; &nbsp; │ &nbsp; ├── controlnet</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">│ &nbsp; &nbsp; &nbsp; │ &nbsp; ├── dance_diffusion</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">│ &nbsp; &nbsp; &nbsp; │ &nbsp; ├── ddim</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">│ &nbsp; &nbsp; &nbsp; │ &nbsp; ├── ddpm</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">│ &nbsp; &nbsp; &nbsp; │ &nbsp; ├── kandinsky</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">│ &nbsp; &nbsp; &nbsp; │ &nbsp; ├── latent_diffusion</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">│ &nbsp; &nbsp; &nbsp; │ &nbsp; ├── latent_diffusion_uncond</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">│ &nbsp; &nbsp; &nbsp; │ &nbsp; ├── repaint</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">│ &nbsp; &nbsp; &nbsp; │ &nbsp; ├── score_sde_ve</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">│ &nbsp; &nbsp; &nbsp; │ &nbsp; ├── semantic_stable_diffusion</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">│ &nbsp; &nbsp; &nbsp; │ &nbsp; ├── spectrogram_diffusion</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">│ &nbsp; &nbsp; &nbsp; │ &nbsp; ├── stable_diffusion</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">│ &nbsp; &nbsp; &nbsp; │ &nbsp; ├── stable_diffusion_safe</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">│ &nbsp; &nbsp; &nbsp; │ &nbsp; ├── text_to_video_synthesis</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">│ &nbsp; &nbsp; &nbsp; │ &nbsp; ├── unclip</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">│ &nbsp; &nbsp; &nbsp; │ &nbsp; ├── unidiffuser</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">│ &nbsp; &nbsp; &nbsp; │ &nbsp; ├── versatile_diffusion</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">│ &nbsp; &nbsp; &nbsp; │ &nbsp; └── vq_diffusion</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">│ &nbsp; &nbsp; &nbsp; ├── schedulers  对应sd webui的采样器</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">│ &nbsp; &nbsp; &nbsp; │ &nbsp; ├── __init__.py</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">│ &nbsp; &nbsp; &nbsp; │ &nbsp; ├── README.md</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">│ &nbsp; &nbsp; &nbsp; │ &nbsp; ├── scheduling_ddim_flax.py</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">│ &nbsp; &nbsp; &nbsp; │ &nbsp; ├── scheduling_ddim.py</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">│ &nbsp; &nbsp; &nbsp; │ &nbsp; ├── scheduling_ddpm.py</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">│ &nbsp; &nbsp; &nbsp; │ &nbsp; ├── scheduling_dpmsolver_sde.py</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">│ &nbsp; &nbsp; &nbsp; │ &nbsp; ├── scheduling_euler_ancestral_discrete.py</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">│ &nbsp; &nbsp; &nbsp; │ &nbsp; ├── scheduling_euler_discrete.py</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">│ &nbsp; &nbsp; &nbsp; │ &nbsp; ├── scheduling_heun_discrete.py</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">│ &nbsp; &nbsp; &nbsp; │ &nbsp; ├── scheduling_ipndm.py</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">│ &nbsp; &nbsp; &nbsp; │ &nbsp; ├── scheduling_karras_ve.py</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">│ &nbsp; &nbsp; &nbsp; │ &nbsp; ├── scheduling_k_dpm_2_ancestral_discrete.py</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">│ &nbsp; &nbsp; &nbsp; │ &nbsp; ├── scheduling_k_dpm_2_discrete.py</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">│ &nbsp; &nbsp; &nbsp; │ &nbsp; ├── scheduling_lms_discrete.py</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">│ &nbsp; &nbsp; &nbsp; │ &nbsp; ├── scheduling_pndm.py</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">│ &nbsp; &nbsp; &nbsp; │ &nbsp; ├── scheduling_repaint.py</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">│ &nbsp; &nbsp; &nbsp; │ &nbsp; ├── scheduling_sde_ve.py</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">│ &nbsp; &nbsp; &nbsp; │ &nbsp; ├── scheduling_sde_vp.py</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">│ &nbsp; &nbsp; &nbsp; │ &nbsp; ├── scheduling_unclip.py</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">│ &nbsp; &nbsp; &nbsp; │ &nbsp; ├── scheduling_utils.py</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">│ &nbsp; &nbsp; &nbsp; │ &nbsp; └── scheduling_vq_diffusion.py</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">│ &nbsp; &nbsp; &nbsp; └── utils</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">├── tests</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">│ &nbsp; ├── models</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">│ &nbsp; ├── pipelines</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">│ &nbsp; └── schedulers</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">├── _typos.toml</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">└── utils</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom-width: 0px; border-bottom-style: solid; border-bottom-color: transparent; top: 1956px;"></div><div class="CodeMirror-gutters" style="display: none; height: 1956px;"></div></div></div></pre><h2 id='diffusers核心逻辑'><span>diffusers核心逻辑</span></h2><h3 id='stable-diffusion加载模型初始化-pipeline'><span>Stable Diffusion加载模型、初始化 pipeline</span></h3><h4 id='diffusionpipelinefrompretrained'><span>DiffusionPipeline.from_pretrained()</span></h4><p><span>下载或者使用本地的模型、根据model_index.json初始化 pipeline 以及其所需要的模块</span></p><ol start='' ><li><p><span>下载模型或者直接使用本地的模型；pretrained_model_name_or_path   </span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="bash" style="break-inside: unset;"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="bash"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9.111112px; left: 7.326416px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: currentcolor;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: currentcolor;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">models--runwayml--stable-diffusion-v1-5</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">├── blobs</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">│ &nbsp; ├── 193490b58ef62739077262e833bf091c66c29488058681ac25cf7df3d8190974</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">│ &nbsp; ├── 1a02ee8abc93e840ffbcb2d68b66ccbcb74b3ab3</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">│ &nbsp; ├── 1b134cded8eb78b184aefb8805b6b572f36fa77b255c483665dda93</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">│ &nbsp; ├── 2c2130b544c0c5a72d5d00da071ba130a9800fb2</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">│ &nbsp; ├── 469be27c5c010538f845f518c4f5e8574c78f7c8</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">│ &nbsp; ├── 4d3e873ab5086ad989f407abd50fdce66db8d657</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">│ &nbsp; ├── 5294955ff7801083f720b34b55d0f1f51313c5c5</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">│ &nbsp; ├── 55d78924fee13e4220f24320127c5f16284e13b9</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">│ &nbsp; ├── 5ba7bf706515bc60487ad0e1816b4929b82542d6</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">│ &nbsp; ├── 5dbd88952e7e521aa665e5052e6db7def3641d03</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">│ &nbsp; ├── 76e821f1b6f0a9709293c3b6b51ed90980b3166b</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">│ &nbsp; ├── 770a47a9ffdcfda0b05506a7888ed714d06131d60267e6cf52765d61cf59fd67</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">│ &nbsp; ├── 82d05b0e688d7ea94675678646c427907419346e</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">│ &nbsp; ├── c7da0e21ba7ea50637bee26e81c220844defdf01aafca02b2c42ecd</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">│ &nbsp; └── daf7e2e2dfc64fb437a2b44525667111b00cb9fc</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">├── refs</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">│ &nbsp; └── main</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">└── snapshots</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  └── aa9ba505e1973ae5cd05f5aedd345178f52f8e6a</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  ├── feature_extractor</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  │ &nbsp; └── preprocessor_config.json <span class="cm-attribute">-</span>&gt; ../../../blobs/5294955ff7801083f720b34b55d0f1f51313c5c5</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  ├── model_index.json <span class="cm-attribute">-</span>&gt; ../../blobs/daf7e2e2dfc64fb437a2b44525667111b00cb9fc</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  ├── safety_checker</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  │ &nbsp; ├── config.json <span class="cm-attribute">-</span>&gt; ../../../blobs/5dbd88952e7e521aa665e5052e6db7def3641d03</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  │ &nbsp; └── pytorch_model.bin <span class="cm-attribute">-</span>&gt; ../../../blobs/193490b58ef62739077262e833bf091c66c29488058681ac25cf7df3d8190974</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  ├── scheduler</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  │ &nbsp; └── scheduler_config.json <span class="cm-attribute">-</span>&gt; ../../../blobs/82d05b0e688d7ea94675678646c427907419346e</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  ├── text_encoder</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  │ &nbsp; ├── config.json <span class="cm-attribute">-</span>&gt; ../../../blobs/4d3e873ab5086ad989f407abd50fdce66db8d657</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  │ &nbsp; └── pytorch_model.bin <span class="cm-attribute">-</span>&gt; ../../../blobs/770a47a9ffdcfda0b05506a7888ed714d06131d60267e6cf52765d61cf59fd67</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  ├── tokenizer</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  │ &nbsp; ├── merges.txt <span class="cm-attribute">-</span>&gt; ../../../blobs/76e821f1b6f0a9709293c3b6b51ed90980b3166b</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  │ &nbsp; ├── special_tokens_map.json <span class="cm-attribute">-</span>&gt; ../../../blobs/2c2130b544c0c5a72d5d00da071ba130a9800fb2</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  │ &nbsp; ├── tokenizer_config.json <span class="cm-attribute">-</span>&gt; ../../../blobs/5ba7bf706515bc60487ad0e1816b4929b82542d6</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  │ &nbsp; └── vocab.json <span class="cm-attribute">-</span>&gt; ../../../blobs/469be27c5c010538f845f518c4f5e8574c78f7c8</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  ├── unet</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  │ &nbsp; ├── config.json <span class="cm-attribute">-</span>&gt; ../../../blobs/1a02ee8abc93e840ffbcb2d68b66ccbcb74b3ab3</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  │ &nbsp; └── diffusion_pytorch_model.bin <span class="cm-attribute">-</span>&gt; ../../../blobs/c7da0e21ba7ea50637bee26e81c220844defdf01aafca02b2c42ecd</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  └── vae</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  ├── config.json <span class="cm-attribute">-</span>&gt; ../../../blobs/55d78924fee13e4220f24320127c5f16284e13b9</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  └── diffusion_pytorch_model.bin <span class="cm-attribute">-</span>&gt; ../../../blobs/1b134cded8eb78b184aefb8805b6b572f36fa77b255c483665dda93</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom-width: 0px; border-bottom-style: solid; border-bottom-color: transparent; top: 956px;"></div><div class="CodeMirror-gutters" style="display: none; height: 956px;"></div></div></div></pre></li><li><p><span>加载模型下目录下的</span><code>model_index.json</code><span>到</span><code>config_dict</code><span>;</span></p><p><span>其实从这里就可以看出来，在训练时，scheduler、unet、text_encoder、tokenizer、vae都已经确定了。但实际推理阶段，我们其实可以更换scheduler（采样器）。</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="json" style="break-inside: unset;"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="json"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9.111112px; left: 7.986084px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: currentcolor;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: currentcolor;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">{</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-string cm-property">"_class_name"</span>: <span class="cm-string">"StableDiffusionPipeline"</span>,</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-string cm-property">"_diffusers_version"</span>: <span class="cm-string">"0.6.0"</span>,</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-string cm-property">"feature_extractor"</span>: [</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-string">"transformers"</span>,</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-string">"CLIPImageProcessor"</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">  ],</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-string cm-property">"safety_checker"</span>: [</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-string">"stable_diffusion"</span>,</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-string">"StableDiffusionSafetyChecker"</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">  ],</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-string cm-property">"scheduler"</span>: [</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-string">"diffusers"</span>,</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-string">"PNDMScheduler"</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">  ],</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-string cm-property">"text_encoder"</span>: [</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-string">"transformers"</span>,</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-string">"CLIPTextModel"</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">  ],</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-string cm-property">"tokenizer"</span>: [</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-string">"transformers"</span>,</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-string">"CLIPTokenizer"</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">  ],</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-string cm-property">"unet"</span>: [</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-string">"diffusers"</span>,</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-string">"UNet2DConditionModel"</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">  ],</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-string cm-property">"vae"</span>: [</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-string">"diffusers"</span>,</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-string">"AutoencoderKL"</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">  ]</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom-width: 0px; border-bottom-style: solid; border-bottom-color: transparent; top: 711px;"></div><div class="CodeMirror-gutters" style="display: none; height: 711px;"></div></div></div></pre></li></ol><ol start='3' ><li><p><span>根据</span><code>config_dict[&quot;_class_name&quot;]</code><span>加载对应的pipeline class;</span></p></li><li><p><span>根据</span><code>model_index.json</code><span>计算初始化管线需要的module；  init_dict, unused_kwargs, _ = pipeline_class.extract_init_dict(config_dict, **kwargs)</span></p></li><li><p><span>加载 pipeline 需要的 model, 作为初始化 pipeline 的参数init_kwargs；</span></p></li><li><p><span>初始化 pipeline，即调用</span><code>StableDiffusionPipeline.__init</code><span>__</span></p></li></ol><h4 id='fromcpkt'><span>from_cpkt</span></h4><p><span>支持加载safetensors文件</span></p><h3 id='pipeline执行推理'><span>pipeline()执行推理 </span></h3><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="python" style="break-inside: unset;"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="python"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9.111112px; left: 7.986084px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: currentcolor;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: currentcolor;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">def</span> <span class="cm-def">__call__</span>(</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable-2">self</span>,</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">prompt</span>: <span class="cm-variable">Union</span>[<span class="cm-builtin">str</span>, <span class="cm-variable">List</span>[<span class="cm-builtin">str</span>]] <span class="cm-operator">=</span> <span class="cm-keyword">None</span>,</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">height</span>: <span class="cm-variable">Optional</span>[<span class="cm-builtin">int</span>] <span class="cm-operator">=</span> <span class="cm-keyword">None</span>,</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">width</span>: <span class="cm-variable">Optional</span>[<span class="cm-builtin">int</span>] <span class="cm-operator">=</span> <span class="cm-keyword">None</span>,</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">num_inference_steps</span>: <span class="cm-builtin">int</span> <span class="cm-operator">=</span> <span class="cm-number">50</span>,</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">guidance_scale</span>: <span class="cm-builtin">float</span> <span class="cm-operator">=</span> <span class="cm-number">7.5</span>,</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">negative_prompt</span>: <span class="cm-variable">Optional</span>[<span class="cm-variable">Union</span>[<span class="cm-builtin">str</span>, <span class="cm-variable">List</span>[<span class="cm-builtin">str</span>]]] <span class="cm-operator">=</span> <span class="cm-keyword">None</span>,</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">num_images_per_prompt</span>: <span class="cm-variable">Optional</span>[<span class="cm-builtin">int</span>] <span class="cm-operator">=</span> <span class="cm-number">1</span>,</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">eta</span>: <span class="cm-builtin">float</span> <span class="cm-operator">=</span> <span class="cm-number">0.0</span>,</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">generator</span>: <span class="cm-variable">Optional</span>[<span class="cm-variable">Union</span>[<span class="cm-variable">torch</span>.<span class="cm-property">Generator</span>, <span class="cm-variable">List</span>[<span class="cm-variable">torch</span>.<span class="cm-property">Generator</span>]]] <span class="cm-operator">=</span> <span class="cm-keyword">None</span>,</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">latents</span>: <span class="cm-variable">Optional</span>[<span class="cm-variable">torch</span>.<span class="cm-property">FloatTensor</span>] <span class="cm-operator">=</span> <span class="cm-keyword">None</span>,</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">prompt_embeds</span>: <span class="cm-variable">Optional</span>[<span class="cm-variable">torch</span>.<span class="cm-property">FloatTensor</span>] <span class="cm-operator">=</span> <span class="cm-keyword">None</span>,</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">negative_prompt_embeds</span>: <span class="cm-variable">Optional</span>[<span class="cm-variable">torch</span>.<span class="cm-property">FloatTensor</span>] <span class="cm-operator">=</span> <span class="cm-keyword">None</span>,</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">output_type</span>: <span class="cm-variable">Optional</span>[<span class="cm-builtin">str</span>] <span class="cm-operator">=</span> <span class="cm-string">"pil"</span>,</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">return_dict</span>: <span class="cm-builtin">bool</span> <span class="cm-operator">=</span> <span class="cm-keyword">True</span>,</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">callback</span>: <span class="cm-variable">Optional</span>[<span class="cm-variable">Callable</span>[[<span class="cm-builtin">int</span>, <span class="cm-builtin">int</span>, <span class="cm-variable">torch</span>.<span class="cm-property">FloatTensor</span>], <span class="cm-keyword">None</span>]] <span class="cm-operator">=</span> <span class="cm-keyword">None</span>,</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">callback_steps</span>: <span class="cm-builtin">int</span> <span class="cm-operator">=</span> <span class="cm-number">1</span>,</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">cross_attention_kwargs</span>: <span class="cm-variable">Optional</span>[<span class="cm-variable">Dict</span>[<span class="cm-builtin">str</span>, <span class="cm-variable">Any</span>]] <span class="cm-operator">=</span> <span class="cm-keyword">None</span>,</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  )</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom-width: 0px; border-bottom-style: solid; border-bottom-color: transparent; top: 444px;"></div><div class="CodeMirror-gutters" style="display: none; height: 444px;"></div></div></div></pre><ol start='' ><li><p><span>参数校验、初始化 height、width、batch_size、prompt_embeds、timesteps、latents</span></p></li><li><p><span>循环推理\降噪</span></p><ul><li><p><span>将图像噪声输入 unet、unet 预测噪声残差</span></p></li><li><p><span>将图像噪声、噪声残差输入Scheduler(即采样器)生成新的图像噪声</span></p></li><li><p><span>循环第一步、将新的图像噪声输入 unet； 一直循环num_inference_steps次</span></p></li></ul><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="python" style="break-inside: unset;"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="python"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9.111112px; left: 7.986084px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: currentcolor;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: currentcolor;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment"># 7. Denoising loop</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">num_warmup_steps</span> <span class="cm-operator">=</span> <span class="cm-builtin">len</span>(<span class="cm-variable">timesteps</span>) <span class="cm-operator">-</span> <span class="cm-variable">num_inference_steps</span> <span class="cm-operator">*</span> <span class="cm-variable-2">self</span>.<span class="cm-property">scheduler</span>.<span class="cm-property">order</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">with</span> <span class="cm-variable-2">self</span>.<span class="cm-property">progress_bar</span>(<span class="cm-variable">total</span><span class="cm-operator">=</span><span class="cm-variable">num_inference_steps</span>) <span class="cm-keyword">as</span> <span class="cm-variable">progress_bar</span>:</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">for</span> <span class="cm-variable">i</span>, <span class="cm-variable">t</span> <span class="cm-keyword">in</span> <span class="cm-builtin">enumerate</span>(<span class="cm-variable">timesteps</span>):</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment"># expand the latents if we are doing classifier free guidance</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">latent_model_input</span> <span class="cm-operator">=</span> <span class="cm-variable">torch</span>.<span class="cm-property">cat</span>([<span class="cm-variable">latents</span>] <span class="cm-operator">*</span> <span class="cm-number">2</span>) <span class="cm-keyword">if</span> <span class="cm-variable">do_classifier_free_guidance</span> <span class="cm-keyword">else</span> <span class="cm-variable">latents</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">latent_model_input</span> <span class="cm-operator">=</span> <span class="cm-variable-2">self</span>.<span class="cm-property">scheduler</span>.<span class="cm-property">scale_model_input</span>(<span class="cm-variable">latent_model_input</span>, <span class="cm-variable">t</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment"># predict the noise residual</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">noise_pred</span> <span class="cm-operator">=</span> <span class="cm-variable-2">self</span>.<span class="cm-property">unet</span>(</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">latent_model_input</span>,</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">t</span>,</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">encoder_hidden_states</span><span class="cm-operator">=</span><span class="cm-variable">prompt_embeds</span>,</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">cross_attention_kwargs</span><span class="cm-operator">=</span><span class="cm-variable">cross_attention_kwargs</span>,</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  ).<span class="cm-property">sample</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment"># perform guidance</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">if</span> <span class="cm-variable">do_classifier_free_guidance</span>:</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">noise_pred_uncond</span>, <span class="cm-variable">noise_pred_text</span> <span class="cm-operator">=</span> <span class="cm-variable">noise_pred</span>.<span class="cm-property">chunk</span>(<span class="cm-number">2</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">noise_pred</span> <span class="cm-operator">=</span> <span class="cm-variable">noise_pred_uncond</span> <span class="cm-operator">+</span> <span class="cm-variable">guidance_scale</span> <span class="cm-operator">*</span> (<span class="cm-variable">noise_pred_text</span> <span class="cm-operator">-</span> <span class="cm-variable">noise_pred_uncond</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment"># compute the previous noisy sample x_t -&gt; x_t-1</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">latents</span> <span class="cm-operator">=</span> <span class="cm-variable-2">self</span>.<span class="cm-property">scheduler</span>.<span class="cm-property">step</span>(<span class="cm-variable">noise_pred</span>, <span class="cm-variable">t</span>, <span class="cm-variable">latents</span>, <span class="cm-operator">**</span><span class="cm-variable">extra_step_kwargs</span>).<span class="cm-property">prev_sample</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment"># call the callback, if provided</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">if</span> <span class="cm-variable">i</span> <span class="cm-operator">==</span> <span class="cm-builtin">len</span>(<span class="cm-variable">timesteps</span>) <span class="cm-operator">-</span> <span class="cm-number">1</span> <span class="cm-keyword">or</span> ((<span class="cm-variable">i</span> <span class="cm-operator">+</span> <span class="cm-number">1</span>) <span class="cm-operator">&gt;</span> <span class="cm-variable">num_warmup_steps</span> <span class="cm-keyword">and</span> (<span class="cm-variable">i</span> <span class="cm-operator">+</span> <span class="cm-number">1</span>) <span class="cm-operator">%</span> <span class="cm-variable-2">self</span>.<span class="cm-property">scheduler</span>.<span class="cm-property">order</span> <span class="cm-operator">==</span> <span class="cm-number">0</span>):</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">progress_bar</span>.<span class="cm-property">update</span>()</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">if</span> <span class="cm-variable">callback</span> <span class="cm-keyword">is</span> <span class="cm-keyword">not</span> <span class="cm-keyword">None</span> <span class="cm-keyword">and</span> <span class="cm-variable">i</span> <span class="cm-operator">%</span> <span class="cm-variable">callback_steps</span> <span class="cm-operator">==</span> <span class="cm-number">0</span>:</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">callback</span>(<span class="cm-variable">i</span>, <span class="cm-variable">t</span>, <span class="cm-variable">latents</span>)</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom-width: 0px; border-bottom-style: solid; border-bottom-color: transparent; top: 644px;"></div><div class="CodeMirror-gutters" style="display: none; height: 644px;"></div></div></div></pre></li><li><p><span>vae decode、safety checker (安全检测、比如鉴黄)</span></p></li></ol><h2 id='如何生成与stable-diffusion-webui相同的结果'><span>如何生成与</span><a href='https://github.com/AUTOMATIC1111/stable-diffusion-webui'><span>stable-diffusion-webui</span></a><span>相同的结果</span></h2><p><span>以下case中使用的模型与参数</span></p><ul><li><p><span>SD Model: </span><a href='https://civitai.com/models/43331/majicmix-realistic'><span>majicmix-realistic</span></a><span> v6</span></p></li><li><p><span>LoRA Model: </span><a href='https://civitai.com/models/12597'><span>MoXin</span></a><span> v1</span></p></li><li><p><span>采样器：Euler A</span></p></li></ul><h3 id='基本功能'><span>基本功能</span></h3><p><span>针对于简单的提示词，和sd webui生成的图是完全一致的。</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="python" style="break-inside: unset;"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="python"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9.111112px; left: 7.326416px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: currentcolor;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: currentcolor;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">import</span> <span class="cm-variable">torch</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">from</span> <span class="cm-variable">torch</span> <span class="cm-keyword">import</span> <span class="cm-variable">autocast</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">from</span> <span class="cm-variable">diffusers</span> <span class="cm-keyword">import</span> <span class="cm-variable">EulerAncestralDiscreteScheduler</span>,<span class="cm-variable">StableDiffusionPipeline</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">from</span> <span class="cm-variable">transformers</span> <span class="cm-keyword">import</span> <span class="cm-variable">CLIPImageProcessor</span>, <span class="cm-variable">CLIPProcessor</span>, <span class="cm-variable">CLIPTextModel</span>,<span class="cm-variable">CLIPTokenizer</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">from</span> <span class="cm-variable">compel</span> <span class="cm-keyword">import</span> <span class="cm-variable">Compel</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">from</span> <span class="cm-variable">diffusers</span>.<span class="cm-property">utils</span> <span class="cm-keyword">import</span> <span class="cm-variable">get_class_from_dynamic_module</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">pipeline</span> <span class="cm-operator">=</span> <span class="cm-variable">StableDiffusionPipeline</span>.<span class="cm-property">from_ckpt</span>(</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-string">"/data/stable-diffusion-webui/models/Stable-diffusion/majicmixRealistic_v6.safetensors"</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">).<span class="cm-property">to</span>(<span class="cm-string">"cuda"</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">pipeline</span>.<span class="cm-property">scheduler</span> <span class="cm-operator">=</span> <span class="cm-variable">EulerAncestralDiscreteScheduler</span>.<span class="cm-property">from_config</span>(<span class="cm-variable">pipeline</span>.<span class="cm-property">scheduler</span>.<span class="cm-property">config</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">pipeline</span>.<span class="cm-property">safety_checker</span> <span class="cm-operator">=</span> <span class="cm-keyword">None</span> <span class="cm-operator">//</span> <span class="cm-variable">默认会启用safety_checker</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">prompt0</span> <span class="cm-operator">=</span> <span class="cm-string">"1girl"</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">generator</span> <span class="cm-operator">=</span> <span class="cm-variable">torch</span>.<span class="cm-property">Generator</span>(<span class="cm-variable">device</span><span class="cm-operator">=</span><span class="cm-string">"cuda"</span>).<span class="cm-property">manual_seed</span>(<span class="cm-number">1432216924</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">with</span> <span class="cm-variable">autocast</span>(<span class="cm-string">"cuda"</span>):</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">images</span> <span class="cm-operator">=</span> <span class="cm-variable">pipeline</span>(</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">prompt0</span>,</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">width</span> <span class="cm-operator">=</span> <span class="cm-number">512</span>,</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">height</span> <span class="cm-operator">=</span> <span class="cm-number">512</span>,</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">num_images_per_prompt</span> <span class="cm-operator">=</span> <span class="cm-number">1</span>,</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">generator</span><span class="cm-operator">=</span><span class="cm-variable">generator</span>,</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">num_inference_steps</span><span class="cm-operator">=</span><span class="cm-number">30</span>,</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">guidance_scale</span><span class="cm-operator">=</span><span class="cm-number">7</span>).<span class="cm-property">images</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">images</span>[<span class="cm-number">0</span>]</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom-width: 0px; border-bottom-style: solid; border-bottom-color: transparent; top: 644px;"></div><div class="CodeMirror-gutters" style="display: none; height: 644px;"></div></div></div></pre><p><img src="http://devops-1255386119.cos.ap-beijing.myqcloud.com/2023-07-13-053520.png" alt="output" style="zoom: 67%;" /></p><h3 id='复杂一些的提示词'><span>复杂一些的提示词</span></h3><p><span>测试中主要发现以下两个问题会导致出图不一致：</span></p><ul><li><p><span>diffusers和</span><a href='https://github.com/AUTOMATIC1111/stable-diffusion-webui'><span>stable-diffusion-webui</span></a><span>提示词权重语法不一致; </span></p><p><a href='https://huggingface.co/docs/diffusers/main/en/using-diffusers/weighted_prompts'><span>diffusers weighted_prompts</span></a><span> </span></p><p><a href='https://github.com/AUTOMATIC1111/stable-diffusion-webui/wiki/Features#attentionemphasis'><span>sd webui attention emphasis</span></a></p></li><li><p><span>diffusers有最大 77提示词token的限制；</span></p><blockquote><p><span>CLIP (Contrastive Language-Image Pretraining) 模型的输入有 75 个 token 的限制，主要是由于在训练 CLIP 模型时，设计者选择了一个固定的最大序列长度。这个限制有助于在计算方面保持效率，并限制模型大小和内存使用。</span></p><p><span>在自然语言处理任务中，输入数据通常具有不同的长度和变化。为了简化计算和提高效率，研究人员通常会设定一个最大序列长度，使得模型在内存和计算机能力范围内高效运行。对于 CLIP 模型，研究者设定了 75 个 token 的最大长度。因此，在使用 CLIP 处理文本数据时，需要将输入截断或填充为 75 个 token。</span></p><p><span>这个限制并不意味着 CLIP 模型只能处理由 75 个 token 构成的数据。在实践中，您可以将较长的输入分割成多个短段，并分别处理，但这需要额外的预处理步骤。在某些情况下，可能需要为超出限制的输入部分选择更合适的截断策略（如确保保留语法结构和主要意义）。</span></p><p><span>总之，CLIP 模型具有 75 个 token 的限制是为了在训练和应用阶段保持内存和计算效率。这种限制在实际应用中可能需要某些额外的预处理和适应步骤。然而，通过选择合适的截断或填充策略，CLIP 模型仍然可以广泛应用于各种自然语言和计算机视觉任务。     --- GPT4生成内容</span></p></blockquote></li></ul><p><span>社区版本的Stable Diffusion实现了与sd webui一样的功能。</span><a href='https://github.com/huggingface/diffusers/blob/main/examples/community/lpw_stable_diffusion.py'><span>Long Prompt Weighting Stable Diffusion community pipeline</span></a></p><p><span>至于为什么不直接加到StableDiffusionPipeline，我理解原因有两个：</span></p><ol start='' ><li><p><span>diffusers创建pipeline很简单，鼓励用户创建自己的pipeline；</span></p></li><li><p><span>提示词权重、token数限制非diffusers的核心功能，且没必要和sd webui保持一致。</span></p></li></ol><p><span>以下代码为使用diffusers </span><a href='https://github.com/huggingface/diffusers/blob/main/examples/community/lpw_stable_diffusion.py'><span>Long Prompt Weighting Stable Diffusion community pipeline</span></a><span>示例,结果与sd webui完全一致：</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="python" style="break-inside: unset;"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="python"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9.111112px; left: 7.326416px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: currentcolor;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: currentcolor;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">import</span> <span class="cm-variable">torch</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">from</span> <span class="cm-variable">torch</span> <span class="cm-keyword">import</span> <span class="cm-variable">autocast</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">from</span> <span class="cm-variable">diffusers</span> <span class="cm-keyword">import</span> <span class="cm-variable">EulerAncestralDiscreteScheduler</span>,<span class="cm-variable">StableDiffusionPipeline</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">from</span> <span class="cm-variable">transformers</span> <span class="cm-keyword">import</span> <span class="cm-variable">CLIPImageProcessor</span>, <span class="cm-variable">CLIPProcessor</span>, <span class="cm-variable">CLIPTextModel</span>,<span class="cm-variable">CLIPTokenizer</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">from</span> <span class="cm-variable">diffusers</span>.<span class="cm-property">utils</span> <span class="cm-keyword">import</span> <span class="cm-variable">get_class_from_dynamic_module</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">stablepipeline</span> <span class="cm-operator">=</span> <span class="cm-variable">StableDiffusionPipeline</span>.<span class="cm-property">from_ckpt</span>(</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-string">"/data/stable-diffusion-webui/models/Stable-diffusion/majicmixRealistic_v6.safetensors"</span>,</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">).<span class="cm-property">to</span>(<span class="cm-string">"cuda"</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">LPWStableDiffusionPipeline</span> <span class="cm-operator">=</span> <span class="cm-variable">get_class_from_dynamic_module</span>(<span class="cm-string">"lpw_stable_diffusion"</span>, <span class="cm-variable">module_file</span><span class="cm-operator">=</span><span class="cm-string">"lpw_stable_diffusion.py"</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">pipeline</span> <span class="cm-operator">=</span> <span class="cm-variable">LPWStableDiffusionPipeline</span>(<span class="cm-operator">**</span><span class="cm-variable">stablepipeline</span>.<span class="cm-property">components</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">pipeline</span>.<span class="cm-property">scheduler</span> <span class="cm-operator">=</span> <span class="cm-variable">EulerAncestralDiscreteScheduler</span>.<span class="cm-property">from_config</span>(<span class="cm-variable">pipeline</span>.<span class="cm-property">scheduler</span>.<span class="cm-property">config</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">pipeline</span>.<span class="cm-property">safety_checker</span> <span class="cm-operator">=</span> <span class="cm-keyword">None</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">pipeline</span>.<span class="cm-property">to</span>(<span class="cm-string">"cuda"</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">prompt</span> <span class="cm-operator">=</span> <span class="cm-string">"((wallpaper 8k)), ((high detailed)), ((masterpiece)), ((best quality:1.2)), ((hdr)), ((absurdres)), ((RAW photo)), 1girl, green eyes, medium hair, bangs, portrait, upper body, shoulder, shirt, simple background, blue background"</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">negative_prompt</span> <span class="cm-operator">=</span> <span class="cm-string">"easynegative,ng_deepnegative_v1_75t, badhandv4,(worst quality:2),(low quality:2),(normal quality:2),lowres,bad anatomy,bad hands,normal quality,((monochrome)),((grayscale)),((watermark)),"</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">generator</span> <span class="cm-operator">=</span> <span class="cm-variable">torch</span>.<span class="cm-property">Generator</span>(<span class="cm-variable">device</span><span class="cm-operator">=</span><span class="cm-string">"cuda"</span>).<span class="cm-property">manual_seed</span>(<span class="cm-number">1432216924</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">with</span> <span class="cm-variable">autocast</span>(<span class="cm-string">"cuda"</span>):</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">images</span> <span class="cm-operator">=</span> <span class="cm-variable">pipeline</span>(</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">prompt</span>,</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">width</span> <span class="cm-operator">=</span> <span class="cm-number">512</span>,</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">height</span> <span class="cm-operator">=</span> <span class="cm-number">512</span>,</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">num_images_per_prompt</span> <span class="cm-operator">=</span> <span class="cm-number">1</span>,</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">generator</span><span class="cm-operator">=</span><span class="cm-variable">generator</span>,</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">negative_prompt</span> <span class="cm-operator">=</span> <span class="cm-variable">negative_prompt</span>,</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">num_inference_steps</span><span class="cm-operator">=</span><span class="cm-number">30</span>,</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">guidance_scale</span><span class="cm-operator">=</span><span class="cm-number">7</span>).<span class="cm-property">images</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">images</span>[<span class="cm-number">0</span>]</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom-width: 0px; border-bottom-style: solid; border-bottom-color: transparent; top: 778px;"></div><div class="CodeMirror-gutters" style="display: none; height: 778px;"></div></div></div></pre><p><img src="http://devops-1255386119.cos.ap-beijing.myqcloud.com/2023-07-13-053525.png" alt="00006-1432216924" style="zoom: 67%;" /></p><h3 id='lora支持'><span>LoRA支持</span></h3><h4 id='单lora支持'><span>单LoRA支持</span></h4><p><span>目前已发布版本(diffusers </span><a href='https://github.com/huggingface/diffusers/releases/tag/v0.18.1'><span>v0.18.1</span></a><span>)仅支持attention layers， 效果不太好。已经有人提交pr </span><a href='https://github.com/huggingface/diffusers/pull/3756'><span>Support to load Kohya-ss style LoRA file format (without restrictions)</span></a><span>,尚未合并。</span></p><p><span>当然除此之外还有其他一些问题，比如</span><a href='https://github.com/huggingface/diffusers/issues/4027'><span>Unload lora weights after they have been loaded</span></a></p><blockquote><p><span>Currently, LoRA is only supported for the attention layers of the </span><code>UNet2DConditionalModel</code><span>. We also support fine-tuning the text encoder for DreamBooth with LoRA in a limited capacity. Fine-tuning the text encoder for DreamBooth generally yields better results, but it can increase compute usage.    </span><a href='https://huggingface.co/docs/diffusers/training/lora'><span>Low-Rank Adaptation of Large Language Models (LoRA)</span></a></p></blockquote><blockquote><p><span>Usually, LoRA fine-tuning of the text encoder along with the UNet leads to better results than LoRA fine-tuning the UNet alone. A reference PR that might be relevant here: </span><a href='https://github.com/huggingface/diffusers/pull/3180'><span>#3180</span></a><span>.    </span><a href='https://github.com/huggingface/diffusers/issues/3219'><span>Docs for LoRA are confusing</span></a></p></blockquote><blockquote><p><span>Discussed in </span><a href='https://github.com/huggingface/diffusers/issues/3064#issuecomment-1544159510'><span>#3064 (comment)</span></a><span>, PR </span><a href='https://github.com/huggingface/diffusers/pull/3437'><span>#3437</span></a><span>. In the PR </span><a href='https://github.com/huggingface/diffusers/pull/3437'><span>#3437</span></a><span>, we implemented the loading of Kohya-ss style LoRA, but this was only support for the Attention part, which had already been implemented in Diffusers. Kohya-ss style LoRA is not only extended to Attention, but also to </span><code>ClipMLP</code><span>, </span><code>Transformer2DModel</code><span>&#39;s </span><code>proj_in</code><span>, </span><code>proj_out</code><span>, and so on. This PR will support these remaining issues.</span></p><p><a href='https://github.com/huggingface/diffusers/pull/3756'><span>Support to load Kohya-ss style LoRA file format (without restrictions)</span></a></p></blockquote><blockquote><p><a href='https://github.com/huggingface/diffusers/issues/3725'><span>failed to use the feature of supporting for A1111 LoRA</span></a></p></blockquote><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="python" style="break-inside: unset;"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="python"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9.111112px; left: 7.326416px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: currentcolor;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: currentcolor;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">import</span> <span class="cm-variable">torch</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">from</span> <span class="cm-variable">torch</span> <span class="cm-keyword">import</span> <span class="cm-variable">autocast</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">from</span> <span class="cm-variable">diffusers</span> <span class="cm-keyword">import</span> <span class="cm-variable">EulerAncestralDiscreteScheduler</span>,<span class="cm-variable">StableDiffusionPipeline</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">from</span> <span class="cm-variable">transformers</span> <span class="cm-keyword">import</span> <span class="cm-variable">CLIPImageProcessor</span>, <span class="cm-variable">CLIPProcessor</span>, <span class="cm-variable">CLIPTextModel</span>,<span class="cm-variable">CLIPTokenizer</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">from</span> <span class="cm-variable">compel</span> <span class="cm-keyword">import</span> <span class="cm-variable">Compel</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">from</span> <span class="cm-variable">diffusers</span>.<span class="cm-property">utils</span> <span class="cm-keyword">import</span> <span class="cm-variable">get_class_from_dynamic_module</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">stablepipeline</span> <span class="cm-operator">=</span> <span class="cm-variable">StableDiffusionPipeline</span>.<span class="cm-property">from_ckpt</span>(</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-string">"/data/stable-diffusion-webui/models/Stable-diffusion/majicmixRealistic_v6.safetensors"</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">).<span class="cm-property">to</span>(<span class="cm-string">"cuda"</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">LPWStableDiffusionPipeline</span> <span class="cm-operator">=</span> <span class="cm-variable">get_class_from_dynamic_module</span>(<span class="cm-string">"lpw_stable_diffusion"</span>, <span class="cm-variable">module_file</span><span class="cm-operator">=</span><span class="cm-string">"lpw_stable_diffusion.py"</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">pipeline</span> <span class="cm-operator">=</span> <span class="cm-variable">LPWStableDiffusionPipeline</span>(<span class="cm-operator">**</span><span class="cm-variable">stablepipeline</span>.<span class="cm-property">components</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">pipeline</span>.<span class="cm-property">scheduler</span> <span class="cm-operator">=</span> <span class="cm-variable">EulerAncestralDiscreteScheduler</span>.<span class="cm-property">from_config</span>(<span class="cm-variable">pipeline</span>.<span class="cm-property">scheduler</span>.<span class="cm-property">config</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">pipeline</span>.<span class="cm-property">feature_extractor</span> <span class="cm-operator">=</span> <span class="cm-variable">CLIPImageProcessor</span>.<span class="cm-property">from_dict</span>(<span class="cm-variable">pipeline</span>.<span class="cm-property">feature_extractor</span>.<span class="cm-property">to_dict</span>())</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">pipeline</span>.<span class="cm-property">safety_checker</span> <span class="cm-operator">=</span> <span class="cm-keyword">None</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">pipeline</span>.<span class="cm-property">load_lora_weights</span>(<span class="cm-string">"/data/stable-diffusion-webui/models/Lora"</span>, <span class="cm-variable">weight_name</span><span class="cm-operator">=</span><span class="cm-string">"moxinv1.khzz.safetensors"</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">prompt</span> <span class="cm-operator">=</span> <span class="cm-string">"1girl"</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">generator</span> <span class="cm-operator">=</span> <span class="cm-variable">torch</span>.<span class="cm-property">Generator</span>(<span class="cm-variable">device</span><span class="cm-operator">=</span><span class="cm-string">"cuda"</span>).<span class="cm-property">manual_seed</span>(<span class="cm-number">1432216924</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">with</span> <span class="cm-variable">autocast</span>(<span class="cm-string">"cuda"</span>):</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">images</span> <span class="cm-operator">=</span> <span class="cm-variable">pipeline</span>(</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">prompt0</span>,</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">width</span> <span class="cm-operator">=</span> <span class="cm-number">512</span>,</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">height</span> <span class="cm-operator">=</span> <span class="cm-number">512</span>,</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">num_images_per_prompt</span> <span class="cm-operator">=</span> <span class="cm-number">1</span>,</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">generator</span><span class="cm-operator">=</span><span class="cm-variable">generator</span>,</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">num_inference_steps</span><span class="cm-operator">=</span><span class="cm-number">30</span>,</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">cross_attention_kwargs</span><span class="cm-operator">=</span>{<span class="cm-string">"scale"</span>: <span class="cm-number">1</span>},</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">guidance_scale</span><span class="cm-operator">=</span><span class="cm-number">7</span>).<span class="cm-property">images</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">images</span>[<span class="cm-number">0</span>]</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom-width: 0px; border-bottom-style: solid; border-bottom-color: transparent; top: 800px;"></div><div class="CodeMirror-gutters" style="display: none; height: 800px;"></div></div></div></pre><center>
<figure>
<img src="http://devops-1255386119.cos.ap-beijing.myqcloud.com/2023-07-13-030013.png" alt="before-face-store-03" style="zoom:67%;" />
<img src="http://devops-1255386119.cos.ap-beijing.myqcloud.com/2023-07-13-025959.png" alt="00018-1432216924" style="zoom:67%;" />
</figure>
</center>
<center>左图为diffusers[v0.18.1]的效果，右图为应用pr之后的效果(与sd webui完全一致)</center><h4 id='多lora支持'><span>多LoRA支持</span></h4><p><span>尚未支持、</span><a href='https://github.com/huggingface/diffusers/issues/2613#top'><span>Support for adding multiple LoRA layers to Diffusers</span></a></p><h3 id='面部修复---codeformer'><span>面部修复 - CodeFormer</span></h3><p><span>diffusers库中并不包含面部修复功能、查看sd webui源码发现其中面部修复的功能是使用了</span><a href='https://github.com/sczhou/CodeFormer'><span>CodeFormer repo</span></a><span>。使用也很简单。</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="python"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="python"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9.111112px; left: 7.326416px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: currentcolor;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: currentcolor;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># Clone CodeFormer and enter the CodeFormer folder</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-operator">!</span><span class="cm-variable">git</span> <span class="cm-variable">clone</span> <span class="cm-variable">https</span>:<span class="cm-operator">//</span><span class="cm-variable">github</span>.<span class="cm-property">com</span><span class="cm-operator">/</span><span class="cm-variable">sczhou</span><span class="cm-operator">/</span><span class="cm-variable">CodeFormer</span>.<span class="cm-property">git</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-operator">%</span><span class="cm-variable">cd</span> &nbsp;<span class="cm-variable">CodeFormer</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># Set up the environment</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># Install python dependencies</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-operator">!</span><span class="cm-variable">pip</span> <span class="cm-variable">install</span> <span class="cm-operator">-</span><span class="cm-variable">r</span> <span class="cm-variable">requirements</span>.<span class="cm-property">txt</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># Install basicsr</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-operator">!</span><span class="cm-variable">python</span> <span class="cm-variable">basicsr</span><span class="cm-operator">/</span><span class="cm-variable">setup</span>.<span class="cm-property">py</span> <span class="cm-variable">develop</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># Download the pre-trained model</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-operator">!</span><span class="cm-variable">python</span> <span class="cm-variable">scripts</span><span class="cm-operator">/</span><span class="cm-variable">download_pretrained_models</span>.<span class="cm-property">py</span> <span class="cm-variable">facelib</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-operator">!</span><span class="cm-variable">python</span> <span class="cm-variable">scripts</span><span class="cm-operator">/</span><span class="cm-variable">download_pretrained_models</span>.<span class="cm-property">py</span> <span class="cm-variable">CodeFormer</span></span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom-width: 0px; border-bottom-style: solid; border-bottom-color: transparent; top: 289px;"></div><div class="CodeMirror-gutters" style="display: none; height: 289px;"></div></div></div></pre><p><span>将需要修复的图像放入inputs目录，执行命令后得到修复后的图片</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="python" style="break-inside: unset;"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="python"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9.111112px; left: 7.326416px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: currentcolor;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: currentcolor;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># Inference the uploaded images</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">#@markdown `CODEFORMER_FIDELITY`: Balance the quality (lower number) and fidelity (higher number)&lt;br&gt;</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># you can add '--bg_upsampler realesrgan' to enhance the background</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">CODEFORMER_FIDELITY</span> <span class="cm-operator">=</span> <span class="cm-number">0.7</span> <span class="cm-comment">#@param {type:"slider", min:0, max:1, step:0.01}</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">#@markdown `BACKGROUND_ENHANCE`: Enhance background image with Real-ESRGAN&lt;br&gt;</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">BACKGROUND_ENHANCE</span> <span class="cm-operator">=</span> <span class="cm-keyword">True</span> <span class="cm-comment">#@param {type:"boolean"}</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">#@markdown `FACE_UPSAMPLE`: Upsample restored faces for high-resolution AI-created images&lt;br&gt;</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">FACE_UPSAMPLE</span> <span class="cm-operator">=</span> <span class="cm-keyword">False</span> <span class="cm-comment">#@param {type:"boolean"}</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">if</span> <span class="cm-variable">BACKGROUND_ENHANCE</span>:</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-keyword">if</span> <span class="cm-variable">FACE_UPSAMPLE</span>:</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-operator">!</span><span class="cm-variable">python</span> <span class="cm-variable">inference_codeformer</span>.<span class="cm-property">py</span> <span class="cm-operator">-</span><span class="cm-variable">w</span> <span class="cm-error">$</span><span class="cm-variable">CODEFORMER_FIDELITY</span> <span class="cm-operator">--</span><span class="cm-variable">input_path</span> <span class="cm-variable">inputs</span> <span class="cm-operator">--</span><span class="cm-variable">bg_upsampler</span> <span class="cm-variable">realesrgan</span> <span class="cm-operator">--</span><span class="cm-variable">face_upsample</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-keyword">else</span>:</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-operator">!</span><span class="cm-variable">python</span> <span class="cm-variable">inference_codeformer</span>.<span class="cm-property">py</span> <span class="cm-operator">-</span><span class="cm-variable">w</span> <span class="cm-error">$</span><span class="cm-variable">CODEFORMER_FIDELITY</span> <span class="cm-operator">--</span><span class="cm-variable">input_path</span> <span class="cm-variable">inputs</span> <span class="cm-operator">--</span><span class="cm-variable">bg_upsampler</span> <span class="cm-variable">realesrgan</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">else</span>:</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-operator">!</span><span class="cm-variable">python</span> <span class="cm-variable">inference_codeformer</span>.<span class="cm-property">py</span> <span class="cm-operator">-</span><span class="cm-variable">w</span> <span class="cm-error">$</span><span class="cm-variable">CODEFORMER_FIDELITY</span> <span class="cm-operator">--</span><span class="cm-variable">input_path</span> <span class="cm-variable">inputs</span></span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom-width: 0px; border-bottom-style: solid; border-bottom-color: transparent; top: 333px;"></div><div class="CodeMirror-gutters" style="display: none; height: 333px;"></div></div></div></pre><h3 id='hiresfix'><span>Hires.fix</span></h3><p><span>diffusers中的高清修复并不像sd webui那样唾手可得，需要我们了解每个步骤的原理，然后组合使用。</span></p><p><a href='https://github.com/huggingface/diffusers/issues/3429'><span>does diffusers have the equivalent to hires fix from A1111?</span></a></p><p><a href='https://github.com/xinntao/Real-ESRGAN'><span>Real-ESRGAN</span></a></p><h4 id='sd-webui是如何实现hiresfix的'><span>sd webui是如何实现Hires.fix的?</span></h4><p><span>txt2img的核心逻辑位于</span></p><ul><li><p><span>文件: processing.py</span></p></li><li><p><span>类:  </span><code>StableDiffusionProcessingTxt2Img(StableDiffusionProcessing)</code><span> </span></p></li><li><p><span>函数: </span><code>sample(self, conditioning, unconditional_conditioning, seeds, subseeds, subseed_strength, prompts</code></p></li></ul><p><img src="http://devops-1255386119.cos.ap-beijing.myqcloud.com/2023-07-13-054317.png" referrerpolicy="no-referrer" alt="image-20230712152457898"></p><p><span>如代码所示，其实text2img + Hires.fix其实就是text2img + upscaler + img2img。</span></p><p><span>其中特别注意Upscaler为latent时，是将图像通过</span><code>torch.nn.functional.interpolate</code><span>处理获得samples；</span></p><blockquote><p><code>torch.nn.functional.interpolate</code><span> 是一个 PyTorch 函数，用于调整（放大或缩小）张量（通常是图像或特征映射）的尺寸。这个函数在计算机视觉和深度学习任务中很常见，尤其是在需要调整图像或特征映射大小以适应模型输入要求、进行上采样或下采样操作时。   </span></p><p><span>---GPT4生成内容</span></p></blockquote><p><span>而其他情况则是调用对应的模型预测得到对应图像，然后vae encode获得samples。Upscaler阶段产生的samples为img2img阶段的输入；详细代码如下：</span></p><p><img src="http://devops-1255386119.cos.ap-beijing.myqcloud.com/2023-07-13-054302.png" referrerpolicy="no-referrer" alt="image-20230712210733311"></p><p><span>其中upscaler用到了</span><a href='https://github.com/xinntao/Real-ESRGAN'><span>Real-ESRGAN</span></a><span>,模型列表如下：</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="python" style="break-inside: unset;"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="python"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9.111112px; left: 7.326416px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: currentcolor;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: currentcolor;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">def</span> <span class="cm-def">get_realesrgan_models</span>(<span class="cm-variable">scaler</span>):</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">try</span>:</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">from</span> <span class="cm-variable">basicsr</span>.<span class="cm-property">archs</span>.<span class="cm-property">rrdbnet_arch</span> <span class="cm-keyword">import</span> <span class="cm-variable">RRDBNet</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">from</span> <span class="cm-variable">realesrgan</span>.<span class="cm-property">archs</span>.<span class="cm-property">srvgg_arch</span> <span class="cm-keyword">import</span> <span class="cm-variable">SRVGGNetCompact</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">models</span> <span class="cm-operator">=</span> [</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">UpscalerData</span>(</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">name</span><span class="cm-operator">=</span><span class="cm-string">"R-ESRGAN General 4xV3"</span>,</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">path</span><span class="cm-operator">=</span><span class="cm-string">"https://github.com/xinntao/Real-ESRGAN/releases/download/v0.2.5.0/realesr-general-x4v3.pth"</span>,</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">scale</span><span class="cm-operator">=</span><span class="cm-number">4</span>,</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">upscaler</span><span class="cm-operator">=</span><span class="cm-variable">scaler</span>,</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">model</span><span class="cm-operator">=</span><span class="cm-keyword">lambda</span>: <span class="cm-variable">SRVGGNetCompact</span>(<span class="cm-variable">num_in_ch</span><span class="cm-operator">=</span><span class="cm-number">3</span>, <span class="cm-variable">num_out_ch</span><span class="cm-operator">=</span><span class="cm-number">3</span>, <span class="cm-variable">num_feat</span><span class="cm-operator">=</span><span class="cm-number">64</span>, <span class="cm-variable">num_conv</span><span class="cm-operator">=</span><span class="cm-number">32</span>, <span class="cm-variable">upscale</span><span class="cm-operator">=</span><span class="cm-number">4</span>, <span class="cm-variable">act_type</span><span class="cm-operator">=</span><span class="cm-string">'prelu'</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  ),</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">UpscalerData</span>(</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">name</span><span class="cm-operator">=</span><span class="cm-string">"R-ESRGAN General WDN 4xV3"</span>,</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">path</span><span class="cm-operator">=</span><span class="cm-string">"https://github.com/xinntao/Real-ESRGAN/releases/download/v0.2.5.0/realesr-general-wdn-x4v3.pth"</span>,</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">scale</span><span class="cm-operator">=</span><span class="cm-number">4</span>,</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">upscaler</span><span class="cm-operator">=</span><span class="cm-variable">scaler</span>,</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">model</span><span class="cm-operator">=</span><span class="cm-keyword">lambda</span>: <span class="cm-variable">SRVGGNetCompact</span>(<span class="cm-variable">num_in_ch</span><span class="cm-operator">=</span><span class="cm-number">3</span>, <span class="cm-variable">num_out_ch</span><span class="cm-operator">=</span><span class="cm-number">3</span>, <span class="cm-variable">num_feat</span><span class="cm-operator">=</span><span class="cm-number">64</span>, <span class="cm-variable">num_conv</span><span class="cm-operator">=</span><span class="cm-number">32</span>, <span class="cm-variable">upscale</span><span class="cm-operator">=</span><span class="cm-number">4</span>, <span class="cm-variable">act_type</span><span class="cm-operator">=</span><span class="cm-string">'prelu'</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  ),</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">UpscalerData</span>(</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">name</span><span class="cm-operator">=</span><span class="cm-string">"R-ESRGAN AnimeVideo"</span>,</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">path</span><span class="cm-operator">=</span><span class="cm-string">"https://github.com/xinntao/Real-ESRGAN/releases/download/v0.2.5.0/realesr-animevideov3.pth"</span>,</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">scale</span><span class="cm-operator">=</span><span class="cm-number">4</span>,</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">upscaler</span><span class="cm-operator">=</span><span class="cm-variable">scaler</span>,</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">model</span><span class="cm-operator">=</span><span class="cm-keyword">lambda</span>: <span class="cm-variable">SRVGGNetCompact</span>(<span class="cm-variable">num_in_ch</span><span class="cm-operator">=</span><span class="cm-number">3</span>, <span class="cm-variable">num_out_ch</span><span class="cm-operator">=</span><span class="cm-number">3</span>, <span class="cm-variable">num_feat</span><span class="cm-operator">=</span><span class="cm-number">64</span>, <span class="cm-variable">num_conv</span><span class="cm-operator">=</span><span class="cm-number">16</span>, <span class="cm-variable">upscale</span><span class="cm-operator">=</span><span class="cm-number">4</span>, <span class="cm-variable">act_type</span><span class="cm-operator">=</span><span class="cm-string">'prelu'</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  ),</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">UpscalerData</span>(</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">name</span><span class="cm-operator">=</span><span class="cm-string">"R-ESRGAN 4x+"</span>,</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">path</span><span class="cm-operator">=</span><span class="cm-string">"https://github.com/xinntao/Real-ESRGAN/releases/download/v0.1.0/RealESRGAN_x4plus.pth"</span>,</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">scale</span><span class="cm-operator">=</span><span class="cm-number">4</span>,</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">upscaler</span><span class="cm-operator">=</span><span class="cm-variable">scaler</span>,</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">model</span><span class="cm-operator">=</span><span class="cm-keyword">lambda</span>: <span class="cm-variable">RRDBNet</span>(<span class="cm-variable">num_in_ch</span><span class="cm-operator">=</span><span class="cm-number">3</span>, <span class="cm-variable">num_out_ch</span><span class="cm-operator">=</span><span class="cm-number">3</span>, <span class="cm-variable">num_feat</span><span class="cm-operator">=</span><span class="cm-number">64</span>, <span class="cm-variable">num_block</span><span class="cm-operator">=</span><span class="cm-number">23</span>, <span class="cm-variable">num_grow_ch</span><span class="cm-operator">=</span><span class="cm-number">32</span>, <span class="cm-variable">scale</span><span class="cm-operator">=</span><span class="cm-number">4</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  ),</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">UpscalerData</span>(</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">name</span><span class="cm-operator">=</span><span class="cm-string">"R-ESRGAN 4x+ Anime6B"</span>,</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">path</span><span class="cm-operator">=</span><span class="cm-string">"https://github.com/xinntao/Real-ESRGAN/releases/download/v0.2.2.4/RealESRGAN_x4plus_anime_6B.pth"</span>,</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">scale</span><span class="cm-operator">=</span><span class="cm-number">4</span>,</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">upscaler</span><span class="cm-operator">=</span><span class="cm-variable">scaler</span>,</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">model</span><span class="cm-operator">=</span><span class="cm-keyword">lambda</span>: <span class="cm-variable">RRDBNet</span>(<span class="cm-variable">num_in_ch</span><span class="cm-operator">=</span><span class="cm-number">3</span>, <span class="cm-variable">num_out_ch</span><span class="cm-operator">=</span><span class="cm-number">3</span>, <span class="cm-variable">num_feat</span><span class="cm-operator">=</span><span class="cm-number">64</span>, <span class="cm-variable">num_block</span><span class="cm-operator">=</span><span class="cm-number">6</span>, <span class="cm-variable">num_grow_ch</span><span class="cm-operator">=</span><span class="cm-number">32</span>, <span class="cm-variable">scale</span><span class="cm-operator">=</span><span class="cm-number">4</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  ),</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">UpscalerData</span>(</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">name</span><span class="cm-operator">=</span><span class="cm-string">"R-ESRGAN 2x+"</span>,</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">path</span><span class="cm-operator">=</span><span class="cm-string">"https://github.com/xinntao/Real-ESRGAN/releases/download/v0.2.1/RealESRGAN_x2plus.pth"</span>,</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">scale</span><span class="cm-operator">=</span><span class="cm-number">2</span>,</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">upscaler</span><span class="cm-operator">=</span><span class="cm-variable">scaler</span>,</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">model</span><span class="cm-operator">=</span><span class="cm-keyword">lambda</span>: <span class="cm-variable">RRDBNet</span>(<span class="cm-variable">num_in_ch</span><span class="cm-operator">=</span><span class="cm-number">3</span>, <span class="cm-variable">num_out_ch</span><span class="cm-operator">=</span><span class="cm-number">3</span>, <span class="cm-variable">num_feat</span><span class="cm-operator">=</span><span class="cm-number">64</span>, <span class="cm-variable">num_block</span><span class="cm-operator">=</span><span class="cm-number">23</span>, <span class="cm-variable">num_grow_ch</span><span class="cm-operator">=</span><span class="cm-number">32</span>, <span class="cm-variable">scale</span><span class="cm-operator">=</span><span class="cm-number">2</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  ),</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  ]</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">return</span> <span class="cm-variable">models</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">except</span> <span class="cm-variable">Exception</span>:</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-builtin">print</span>(<span class="cm-string">"Error making Real-ESRGAN models list:"</span>, <span class="cm-variable">file</span><span class="cm-operator">=</span><span class="cm-variable">sys</span>.<span class="cm-property">stderr</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-builtin">print</span>(<span class="cm-variable">traceback</span>.<span class="cm-property">format_exc</span>(), <span class="cm-variable">file</span><span class="cm-operator">=</span><span class="cm-variable">sys</span>.<span class="cm-property">stderr</span>)</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom-width: 0px; border-bottom-style: solid; border-bottom-color: transparent; top: 1156px;"></div><div class="CodeMirror-gutters" style="display: none; height: 1156px;"></div></div></div></pre><h4 id='diffusers中应该如何实现'><span>diffusers中应该如何实现</span></h4><p><span>其实很简单，跟sd webui一样，把文生图的结果upscaler然后放到图生图再跑一下就好了。</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="python" style="break-inside: unset;"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="python"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9.111112px; left: 7.326416px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: currentcolor;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: currentcolor;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">import</span> <span class="cm-variable">torch</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">from</span> <span class="cm-variable">torch</span> <span class="cm-keyword">import</span> <span class="cm-variable">autocast</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">from</span> <span class="cm-variable">diffusers</span> <span class="cm-keyword">import</span> <span class="cm-variable">EulerAncestralDiscreteScheduler</span>,<span class="cm-variable">StableDiffusionPipeline</span>,<span class="cm-variable">StableDiffusionImg2ImgPipeline</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">from</span> <span class="cm-variable">transformers</span> <span class="cm-keyword">import</span> <span class="cm-variable">CLIPImageProcessor</span>, <span class="cm-variable">CLIPProcessor</span>, <span class="cm-variable">CLIPTextModel</span>,<span class="cm-variable">CLIPTokenizer</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">from</span> <span class="cm-variable">diffusers</span>.<span class="cm-property">utils</span> <span class="cm-keyword">import</span> <span class="cm-variable">get_class_from_dynamic_module</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">stablepipeline</span> <span class="cm-operator">=</span> <span class="cm-variable">StableDiffusionPipeline</span>.<span class="cm-property">from_ckpt</span>(</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-string">"/data/stable-diffusion-webui/models/Stable-diffusion/majicmixRealistic_v6.safetensors"</span>,</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">).<span class="cm-property">to</span>(<span class="cm-string">"cuda"</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">LPWStableDiffusionPipeline</span> <span class="cm-operator">=</span> <span class="cm-variable">get_class_from_dynamic_module</span>(<span class="cm-string">"lpw_stable_diffusion"</span>, <span class="cm-variable">module_file</span><span class="cm-operator">=</span><span class="cm-string">"lpw_stable_diffusion.py"</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">text2img</span> <span class="cm-operator">=</span> <span class="cm-variable">LPWStableDiffusionPipeline</span>(<span class="cm-operator">**</span><span class="cm-variable">stablepipeline</span>.<span class="cm-property">components</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">text2img</span>.<span class="cm-property">scheduler</span> <span class="cm-operator">=</span> <span class="cm-variable">EulerAncestralDiscreteScheduler</span>.<span class="cm-property">from_config</span>(<span class="cm-variable">text2img</span>.<span class="cm-property">scheduler</span>.<span class="cm-property">config</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">text2img</span>.<span class="cm-property">safety_checker</span> <span class="cm-operator">=</span> <span class="cm-keyword">None</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">text2img</span>.<span class="cm-property">to</span>(<span class="cm-string">"cuda"</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">prompt</span> <span class="cm-operator">=</span> <span class="cm-string">"1girl"</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">generator</span> <span class="cm-operator">=</span> <span class="cm-variable">torch</span>.<span class="cm-property">Generator</span>(<span class="cm-variable">device</span><span class="cm-operator">=</span><span class="cm-string">"cuda"</span>).<span class="cm-property">manual_seed</span>(<span class="cm-number">1432216924</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">img2img</span> <span class="cm-operator">=</span> <span class="cm-variable">StableDiffusionImg2ImgPipeline</span>(<span class="cm-operator">**</span><span class="cm-variable">text2img</span>.<span class="cm-property">components</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">with</span> <span class="cm-variable">autocast</span>(<span class="cm-string">"cuda"</span>):</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">images</span> <span class="cm-operator">=</span> <span class="cm-variable">text2img</span>(</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">prompt</span>,</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">width</span> <span class="cm-operator">=</span> <span class="cm-number">512</span>,</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">height</span> <span class="cm-operator">=</span> <span class="cm-number">512</span>,</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">num_images_per_prompt</span> <span class="cm-operator">=</span> <span class="cm-number">1</span>,</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">generator</span><span class="cm-operator">=</span><span class="cm-variable">generator</span>,</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">#negative_prompt = negative_prompt,</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">num_inference_steps</span><span class="cm-operator">=</span><span class="cm-number">20</span>,</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">guidance_scale</span><span class="cm-operator">=</span><span class="cm-number">7</span>).<span class="cm-property">images</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 这里偷懒了,只是把图片拉伸了，其实完全可抄一下sd webui的代码</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">images</span>[<span class="cm-number">0</span>] <span class="cm-operator">=</span> <span class="cm-variable">images</span>[<span class="cm-number">0</span>].<span class="cm-property">resize</span>((<span class="cm-number">512</span><span class="cm-operator">*</span><span class="cm-number">2</span>, <span class="cm-number">512</span><span class="cm-operator">*</span><span class="cm-number">2</span>))</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">with</span> <span class="cm-variable">autocast</span>(<span class="cm-string">"cuda"</span>):</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">images</span> <span class="cm-operator">=</span> <span class="cm-variable">img2img</span>(</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">prompt</span><span class="cm-operator">=</span><span class="cm-string">"1girl"</span>,</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">image</span><span class="cm-operator">=</span><span class="cm-variable">images</span>[<span class="cm-number">0</span>],</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">strength</span><span class="cm-operator">=</span><span class="cm-number">0.7</span>,</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">num_inference_steps</span><span class="cm-operator">=</span><span class="cm-number">20</span>,</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">guidance_scale</span><span class="cm-operator">=</span><span class="cm-number">7</span>,</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">num_images_per_prompt</span><span class="cm-operator">=</span><span class="cm-number">1</span>,</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">generator</span><span class="cm-operator">=</span><span class="cm-variable">generator</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  ).<span class="cm-property">images</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">images</span>[<span class="cm-number">0</span>]</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom-width: 0px; border-bottom-style: solid; border-bottom-color: transparent; top: 1089px;"></div><div class="CodeMirror-gutters" style="display: none; height: 1089px;"></div></div></div></pre><h3 id='相对于sd-webui的优缺点'><span>相对于sd webui的优缺点</span></h3><p><span>代码结构简单、清晰、二次开发简单、支持</span><a href='https://huggingface.co/docs/diffusers/v0.18.2/en/training/distributed_inference#accelerate'><span>多卡分布式推理</span></a></p><p><a href='https://github.com/AUTOMATIC1111/stable-diffusion-webui/discussions/1621'><span>sd webui多显卡支持情况</span></a></p><p><span>不如sd webui 功能齐全、很多功能需要自行组合，非开箱即用 比如面部修复、Hires.fix等</span></p><p><span>如果要用diffusers复现sd webui的功能肯定是可行的，不过要有些工作量。好的方面是目前diffusers社区非常活跃、更新速度很快。</span></p><h2 id='写在最后'><span>写在最后</span></h2><p><span>以上算是对于stable diffusion以及diffusers一个短期的学习总结，由于本人是非算法背景，很多地方还在学习中，难免有很多不正确的地方，有任何问题欢迎随时指出。</span></p><p><span>另外本文有很多地方没有提到，比如controlnet、unclip、部署、训练等，有需要或者有精力再填坑。</span></p><h2 id='附1-stable-diffusion-webui--diffusers安装'><span>附1 stable diffusion webui &amp;&amp; diffusers安装</span></h2><pre class="md-fences md-end-block ty-contain-cm modeLoaded md-focus" spellcheck="false" lang="bash" style="break-inside: unset;"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap CodeMirror-focused" lang="bash"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 453.555577px; left: 372.031264px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: currentcolor;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: currentcolor;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="" style="position: relative;"><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">yum install <span class="cm-attribute">-y</span> <span class="cm-builtin">git</span> python3-opencv</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-builtin">wget</span> https://repo.anaconda.com/miniconda/Miniconda3-latest-Linux-x86_64.sh</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-builtin">bash</span> Miniconda3-latest-Linux-x86_64.sh <span class="cm-attribute">-b</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-builtin">mkdir</span> /data</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">mount /dev/vdb /data</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">conda create <span class="cm-attribute">-n</span> sd-webui <span class="cm-def">python</span><span class="cm-operator">=</span><span class="cm-number">3</span>.10</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">conda activate sd-webui</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-builtin">git</span> clone https://github.com/AUTOMATIC1111/stable-diffusion-webui.git</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-builtin">cd</span> stable-diffusion-webui</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-builtin">sed</span> <span class="cm-attribute">-i</span> <span class="cm-string">'s/can_run_as_root=0/can_run_as_root=1/g'</span> webui.sh &amp;&amp; ./webui.sh </span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">conda create <span class="cm-attribute">-n</span> py3.8 <span class="cm-def">python</span><span class="cm-operator">==</span><span class="cm-number">3</span>.8</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">conda activate py3.8</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">conda update <span class="cm-attribute">-y</span> conda</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">conda list</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">conda install <span class="cm-attribute">-y</span> numpy matplotlib pandas </span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">conda install pytorch torchvision torchaudio <span class="cm-def">pytorch-cuda</span><span class="cm-operator">=</span><span class="cm-number">11</span>.7 <span class="cm-attribute">-c</span> pytorch <span class="cm-attribute">-c</span> nvidia</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">conda install <span class="cm-attribute">-c</span> huggingface transformers diffusers</span></pre><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">conda install <span class="cm-attribute">-y</span> jupyter notebook requests</span></pre></div></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom-width: 0px; border-bottom-style: solid; border-bottom-color: transparent; top: 467px;"></div><div class="CodeMirror-gutters" style="display: none; height: 467px;"></div></div></div></pre><h2 id='附2-开发环境'><span>附2 开发环境</span></h2><p><span>以上实例代码都是在jupter notebook中可运行的。如以其他方式运行，需要做些变更。</span></p><h2 id='附3-一些参考链接'><span>附3 一些参考链接</span></h2><ul><li><p><a href='https://afoo.me/posts/2023-04-29-stablediffusion-webui-alternatives.html'><span>不知道Stable Diffusion Web UI应该怎么选？ 看这一篇就够了！</span></a></p></li><li><p><a href='https://huggingface.co/blog/controlnet' target='_blank' class='url'>https://huggingface.co/blog/controlnet</a></p></li><li><p><a href='https://pytorch.org/blog/accelerated-diffusers-pt-20/' target='_blank' class='url'>https://pytorch.org/blog/accelerated-diffusers-pt-20/</a></p></li><li><p><a href='https://huggingface.co/docs/diffusers/v0.18.2/en/training/distributed_inference#accelerate' target='_blank' class='url'>https://huggingface.co/docs/diffusers/v0.18.2/en/training/distributed_inference#accelerate</a></p></li><li><p><a href='https://huggingface.co/blog/stable_diffusion#how-does-stable-diffusion-work'><span>https://huggingface.co/blog/stable_diffusion#how-does-stable-diffusion-work</span></a></p></li></ul><p><span>若有格式问题或者后续更新，可见原文。</span><a href='https://binnn6.github.io/posts/diffusers%E8%B0%83%E7%A0%94.html'><span>🤗 D🧨 ffusers调研</span></a></p><p>&nbsp;</p></div></div>

<script>(function (){var e=document.body.parentElement,t=[],n=null,i=document.body.classList.contains("typora-export-collapse-outline"),r=function(e,t,n){document.addEventListener(e,function(e){if(!e.defaultPrevented)for(var i=e.target;i&&i!=this;i=i.parentNode)if(i.matches(t)){!1===n.call(i,e)&&(e.preventDefault(),e.stopPropagation());break}},!1)};function o(){return e.scrollTop}r("click",".outline-expander",function(e){var t=this.closest(".outline-item-wrapper").classList;return t.contains("outline-item-open")?t.remove("outline-item-open"):t.add("outline-item-open"),d(),!1}),r("click",".outline-item",function(e){var t=this.querySelector(".outline-label");if(location.hash="#"+t.getAttribute("href"),i){var n=this.closest(".outline-item-wrapper").classList;n.contains("outline-item-open")||n.add("outline-item-open"),c(),n.add("outline-item-active")}});var a,s,l=function(){var e=o();n=null;for(var i=0;i<t.length&&t[i][1]-e<60;i++)n=t[i]},c=function(){document.querySelectorAll(".outline-item-active").forEach(e=>e.classList.remove("outline-item-active")),document.querySelectorAll(".outline-item-single.outline-item-open").forEach(e=>e.classList.remove("outline-item-open"))},d=function(){if(n){c();var e=document.querySelector('.outline-label[href="#'+(CSS.escape?CSS.escape(n[0]):n[0])+'"]');if(e)if(i){var t=e.closest(".outline-item-open>ul>.outline-item-wrapper");if(t)t.classList.add("outline-item-active");else{for(var r=(e=e.closest(".outline-item-wrapper")).parentElement.closest(".outline-item-wrapper");r;)r=(e=r).parentElement.closest(".outline-item-wrapper");e.classList.add("outline-item-active")}}else e.closest(".outline-item-wrapper").classList.add("outline-item-active")}};window.addEventListener("scroll",function(e){a&&clearTimeout(a),a=setTimeout(function(){l(),d()},300)});var u=function(){s=setTimeout(function(){!function(){t=[];var e=o();document.querySelector("#write").querySelectorAll("h1, h2, h3, h4, h5, h6").forEach(n=>{var i=n.getAttribute("id");t.push([i,e+n.getBoundingClientRect().y])})}(),l(),d()},300)};window.addEventListener("resize",function(e){s&&clearTimeout(s),u()}),u()})();</script></body>
</html>